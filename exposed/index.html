
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM" />
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Kotlin 기반 경량 ORM Exposed 정리 Part 1 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"이전 Exposed 포스팅#\nKotlin 기반 경량 ORM Exposed 정리 Part 1\nKotlin 기반 경량 ORM Exposed 정리 Part 2\nKotlin 기반 경량 ORM Exposed 정리 Part 3\n\n\n해당 코드는 Github 공개되어 있습니다.\n\nExposed 란 ?#Exposed는 JetBrains에서 만든 Kotlin 언어 기반의 ORM 프레임워크입니다. Exposed는 두 가지 레벨의 데이터베이스 access를 제공합니다. SQL을 매핑 한 DSL 방식, 경량화한 DAO 방식을 제공하며 공식적으로 H2, MySQL, MariaDB, Oracle, PostgreSQL, SQL Server, SQLite 데이터베이스를 지원합니다.\n그래서 왜 쓰는 데 ?#저는 개인적, 회사 업무에서 Spring Data JPA를 주로 사용하고 있습니다. JPA가 가져다주는 큰 장점이 많아 적극적으로 사용하고 있지만 특정 상황에서 하이버네이트의 단점이 있어 이를 보안하기 위해서 Exposed를 사용하고 있습니다. 해당 내용은 Batch Insert 성능 향상기 1편 - With JPA, Batch Insert 성능 향상기 2편 - 성능 측정에서 포스팅한 바 있습니다.\nGetting Started#MySQL#12345678910111213141516171819version: &#x27;3&#x27;services:    db_mysql:        container_name: mysql.local        image: mysql/mysql-server:5.7        environment:            MYSQL_ROOT_HOST: &#x27;%&#x27;            MYSQL_DATABASE: &#x27;exposed_study&#x27;            MYSQL_ALLOW_EMPTY_PASSWORD: &#x27;yes&#x27;        ports:            - &#x27;3366:3306&#x27;        volumes:            - &#x27;./volumes/mysql/default:/var/lib/mysql&#x27;        command:            - &#x27;mysqld&#x27;            - &#x27;--character-set-server=utf8mb4&#x27;            - &#x27;--collation-server=utf8mb4_unicode_ci&#x27;            - &#x27;--sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;\n\n1$ docker-compose up -d\n\nExposed에서 지원해 주는 MySQL 기반으로 진행하기 위해서 해당 환경을 Docker로 구성합니다.\nGradle#1234567dependencies &#123;    implementation(&quot;mysql:mysql-connector-java&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-core:0.31.1&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-dao:0.31.1&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-jdbc:0.31.1&quot;)    implementation(&quot;org.jetbrains.exposed:exposed-java-time:0.31.1&quot;)&#125;\n\n필요한 의존성을 추가합니다.\nConfig#1234567891011class ExposedGettingStarted &#123;    private val config = HikariConfig().apply &#123;        jdbcUrl = &quot;jdbc:mysql://localhost:3366/exposed_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&quot;        driverClassName = &quot;com.mysql.cj.jdbc.Driver&quot;        username = &quot;root&quot;        password = &quot;&quot;    &#125;    private val dataSource = HikariDataSource(config)    ...&#125;\n\nHikariConfig에 위에서 생성한 MySQL 정보를 입력하여 DataSource를 생성합니다.\nDSL 방식#1234567891011121314151617181920212223242526272829303132333435363738394041424344454647object Payments : LongIdTable(name = &quot;payment&quot;) &#123;    val orderId = long(&quot;order_id&quot;)    val amount = decimal(&quot;amount&quot;, 19, 4)&#125;class ExposedGettingStarted &#123;    @Test    fun `exposed DSL`() &#123;        // connection to MySQL        Database.connect(dataSource)        transaction &#123;            // Show SQL logging            addLogger(StdOutSqlLogger)            // CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)            SchemaUtils.create(Payments)            // INSERT INTO payment (amount, order_id) VALUES (1, 1)            // ...            (1..5).map &#123;                Payments.insert &#123; payments -&gt;                    payments[amount] = it.toBigDecimal()                    payments[orderId] = it.toLong()                &#125;            &#125;            // UPDATE payment SET amount=0 WHERE payment.amount &gt;= 0            Payments.update(&#123; amount greaterEq BigDecimal.ZERO &#125;)            &#123;                it[amount] = BigDecimal.ZERO            &#125;            // SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount = 0            // Payment(amount=1.0000, orderId=1)            Payments.select &#123; amount eq BigDecimal.ZERO &#125;                .forEach &#123; println(it) &#125;            // DELETE FROM payment WHERE payment.amount &gt;= 1            Payments.deleteWhere &#123; amount greaterEq BigDecimal.ONE &#125;            // DROP TABLE IF EXISTS payment            SchemaUtils.drop(Payments)        &#125;    &#125;&#125;\n\nPayments객체에 테이블 정보를 작성 하여 테이블을 생성하여 Insert, Select, Update, Delete를 하고 테이블을 Drop 합니다. SQL를 매핑한 DSL 방식으로 코틀린 코드 베이스로 SQL을 조작할 수 있습니다.\nDAO 방식#12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849class Payment(id: EntityID&lt;Long&gt;) : LongEntity(id) &#123;    companion object : LongEntityClass&lt;Payment&gt;(Payments)    var amount by Payments.amount    var orderId by Payments.orderId&#125;class ExposedGettingStarted &#123;    @Test    fun `exposed DAO`() &#123;        // connection to MySQL        Database.connect(dataSource)        transaction &#123;            // Show SQL logging            addLogger(StdOutSqlLogger)            // CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)            SchemaUtils.create(Payments)            // INSERT INTO payment (amount, order_id) VALUES (1, 1)            // ...            (1..20).map &#123;                Payment.new &#123;                    amount = it.toBigDecimal()                    orderId = it.toLong()                &#125;            &#125;            // UPDATE payment SET amount=0 WHERE id = 1            // ...            Payment.all()                .forEach &#123; it.amount = BigDecimal.ZERO &#125;            // SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount &gt;= 1            // Payment(amount=1.0000, orderId=1)            Payment.find &#123; amount eq BigDecimal.ONE &#125;                .forEach &#123; println(it) &#125;            // DELETE FROM payment WHERE payment.id = 1            // ...            Payment.all()                .forEach &#123; it.delete() &#125;            // DROP TABLE IF EXISTS payment            SchemaUtils.drop(Payments)        &#125;    &#125;&#125;\n\nDSL 객체인 Payments 기반으로 DAO Payment를 객체를 생성합니다. DAO는 payment 테이블에 대한 Data Access Object의 기능을 전담하게 됩니다. Data JPA의 Repository와 비슷한 개념입니다.\nWith Spring Boot#Exposed에서는 Spring Boot를 지원하는 exposed-spring-boot-starter 의존성을 제공하고 있습니다.\ngradle#1implementation(&quot;org.jetbrains.exposed:exposed-spring-boot-starter:0.31.1&quot;)\n\n스프링 부트에서 공식적으로 지원하는 의존성은 아니기 때문에 버전을 명확하게 명시해야 합니다.\nproperties#1234567891011spring:    datasource:        url: jdbc:mysql://localhost:3366/exposed_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&amp;logger=Slf4JLogger&amp;profileSQL=false&amp;maxQuerySizeToLog=100000        username: root        password:        driver-class-name: com.mysql.cj.jdbc.Driver    exposed:        generate-ddl: true#        excluded-packages: com.example.exposedstudylogging.level.Exposed: debug\n\ndatasource에 대한 설정을 스프링 부트에서 사용하는 방식 그대로 사용할 수 있고 generate-ddl 설정이 활성화되어 있는 경우 데이터베이스 스키마를 생성하고, 특정 스키마를 제외하고 싶은 경우 excluded-packages 설정으로 제외할 수 있습니다. 실제 코드를 보면 매우 단순합니다. logging.level.Exposed: debug 경우 별도의 설정 없이 Show SQL Log를 볼 수 있습니다.\n12345678910111213141516171819202122232425262728293031323334353637383940414243@Configuration@AutoConfigureAfter(DataSourceAutoConfiguration::class)@EnableTransactionManagementopen class ExposedAutoConfiguration(private val applicationContext: ApplicationContext) &#123;    @Value(&quot;\\$&#123;spring.exposed.excluded-packages:&#125;#&#123;T(java.util.Collections).emptyList()&#125;&quot;)    private lateinit var excludedPackages: List&lt;String&gt;    @Bean    open fun springTransactionManager(datasource: DataSource) = SpringTransactionManager(datasource)    @Bean    @ConditionalOnProperty(&quot;spring.exposed.generate-ddl&quot;, havingValue = &quot;true&quot;, matchIfMissing = false)    open fun databaseInitializer() = DatabaseInitializer(applicationContext, excludedPackages)&#125;open class DatabaseInitializer(private val applicationContext: ApplicationContext, private val excludedPackages: List&lt;String&gt;) : ApplicationRunner, Ordered &#123;    override fun getOrder(): Int = DATABASE_INITIALIZER_ORDER    companion object &#123;        const val DATABASE_INITIALIZER_ORDER = 0    &#125;    private val logger = LoggerFactory.getLogger(javaClass)    @Transactional    override fun run(args: ApplicationArguments?) &#123;        val exposedTables = discoverExposedTables(applicationContext, excludedPackages)        logger.info(&quot;Schema generation for tables &#x27;&#123;&#125;&#x27;&quot;, exposedTables.map &#123; it.tableName &#125;)        logger.info(&quot;ddl &#123;&#125;&quot;, exposedTables.map &#123; it.ddl &#125;.joinToString())        SchemaUtils.create(*exposedTables.toTypedArray())    &#125;&#125;fun discoverExposedTables(applicationContext: ApplicationContext, excludedPackages: List&lt;String&gt;): List&lt;Table&gt; &#123;    val provider = ClassPathScanningCandidateComponentProvider(false)    provider.addIncludeFilter(AssignableTypeFilter(Table::class.java))    excludedPackages.forEach &#123; provider.addExcludeFilter(RegexPatternTypeFilter(Pattern.compile(it.replace(&quot;.&quot;, &quot;\\\\.&quot;) + &quot;.*&quot;))) &#125;    val packages = AutoConfigurationPackages.get(applicationContext)    val components = packages.map &#123; provider.findCandidateComponents(it) &#125;.flatten()    return components.map &#123; Class.forName(it.beanClassName).kotlin.objectInstance as Table &#125;&#125;\n\n스프링 표현식으로 제외 시킬 excludedPackages를 List로 받고, generate-ddl 여부에 따라 DatabaseInitializer 빈을 등록여부를 결정합니다. 만약 해당 빈을 등록하게 되면 DatabaseInitializer 객체가 ApplicationRunner을 구현하고 있기 때문에 스프링 어플리케이션이 실행하는 경우 run() 메서드에서 스키마를 생성하게 됩니다. (excludedPackages는 제외)\nrun() 메서드에 @Transactional 어노테이션이 있는 것을 볼 수 있습니다. 이것은 spring-transaction모듈을 통해서 TransactionSynchronizationManager를 기반으로 스프링의 트랜잭션 메커니즘을 그대로 사용할 수 있다는 의미 입니다.\n\n스프링의 트랜잭션 동기화 메커니즘토비의 스프링 3.1, 361 페이지스프링은 위와 같은 방식으로 트랜잭션 동기화를 진행합니다. 해당 방식은 트랜잭션을 시작하기 위해 만든 Connection 오브젝트를 특별한 저장소에 보관해두고, 이후에 호출되는 메서드에서 저장된 Connection을 가져다가 사용합니다.\n\nTesting in Spring Boot#1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889@SpringBootTest@Transactional@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)@ActiveProfiles(&quot;test&quot;)open class ExposedTestSupportclass ExposedGettingStartedInSpringBoot : ExposedTestSupport() &#123;    @Test    fun `exposed DAO`() &#123;        // connection to MySQL        // Database.connect(dataSource) 스프링 Bean의 DataSource를 사용하기 때문에 주석        // transaction &#123; 스프링 @Transactional 으로 트랜잭션을 시작하기 때문에 주석        // Show SQL logging        // addLogger(StdOutSqlLogger)  logging.level.Exposed: debug 으로 Show SQL logging 확인        // CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)        //  SchemaUtils.create(Payments)  generate-ddl: true 으로 스키마 생성        // INSERT INTO payment (amount, order_id) VALUES (1, 1)        // ...        (1..20).map &#123;            Payment.new &#123;                amount = it.toBigDecimal()                orderId = it.toLong()            &#125;        &#125;        // UPDATE payment SET amount=0 WHERE id = 1        // ...        Payment.all()            .forEach &#123; it.amount = BigDecimal.ZERO &#125;        // SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount &gt;= 1        // Payment(amount=1.0000, orderId=1)        Payment.find &#123; amount eq BigDecimal.ONE &#125;            .forEach &#123; println(it) &#125;        // DELETE FROM payment WHERE payment.id = 1        // ...        Payment.all()            .forEach &#123; it.delete() &#125;        // DROP TABLE IF EXISTS payment        // SchemaUtils.drop(Payments)        // &#125;    &#125;    @Test    fun `exposed DSL`() &#123;        // connection to MySQL        // Database.connect(dataSource) 스프링 Bean의 DataSource를 사용하기 때문에 주석        // transaction &#123; 스프링 @Transactional 으로 트랜잭션을 시작하기 때문에 주석        // Show SQL logging        // addLogger(StdOutSqlLogger)  logging.level.Exposed: debug 으로 Show SQL logging 확인        // CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)        //  SchemaUtils.create(Payments)  generate-ddl: true 으로 스키마 생성        // INSERT INTO payment (amount, order_id) VALUES (1, 1)        // ...        (1..5).map &#123;            Payments.insert &#123; payments -&gt;                payments[amount] = it.toBigDecimal()                payments[orderId] = it.toLong()            &#125;        &#125;        // UPDATE payment SET amount=0 WHERE payment.amount &gt;= 0        Payments.update(&#123; amount greaterEq BigDecimal.ZERO &#125;)        &#123;            it[amount] = BigDecimal.ZERO        &#125;        // SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount = 0        // Payment(amount=1.0000, orderId=1)        Payments.select &#123; amount eq BigDecimal.ZERO &#125;            .forEach &#123; println(it) &#125;        // DELETE FROM payment WHERE payment.amount &gt;= 1        Payments.deleteWhere &#123; amount greaterEq BigDecimal.ONE &#125;        // DROP TABLE IF EXISTS payment        // SchemaUtils.drop(Payments)        // &#125;    &#125;&#125;\n\nDataSource는 스프링 Bean을 사용하기 때문에 제거했으며, transaction &#123; ... &#125;으로 트랜잭션을 시작했던 코드를 스프링의 @Transactional으로 대체했습니다. 또한 SchemaUtils.create(Payments)으로 스키마를 생성했던 부분을 generate-ddl: true 속성 파일로 대체했습니다. 그리고 ExposedTestSupport 객체에 @Transactional가 있어 테스트 코드의 최종 데이터는 모두 Rollback을 진행하게 됩니다. Spring 환경에서 Exposed를 사용하게 되면 보다 간결하게 사용 가능합니다.\n심화#batch insert#123456789101112131415@Testfun `batch insert`() &#123;    val data = (1..10).map &#123; it &#125;    Books.batchInsert(        data,        ignore = false,        shouldReturnGeneratedValues = false    ) &#123;        this[Books.writer] = 1L        this[Books.title] = &quot;$it-title&quot;        this[Books.price] = it.toBigDecimal()        this[Books.createdAt] = LocalDateTime.now()        this[Books.updatedAt] = LocalDateTime.now()    &#125;&#125;\n\nExposed는 batchInsert() 메서드를 지원하기 때문에 쉽게 batch insert를 진행할 수 있습니다. Mysql의 경우 JDBC 드라이버에 rewriteBatchedStatements=true 속성을 반드시 입력해야 batch insert가 가능합니다. shouldReturnGeneratedValues 값을 false로 지정하면 auto_increment으로 증가된 ID 값을 가져오지 않기에 성능이 향상될 수 있습니다.\n\n로그에 출력되는 SQL은 batch insert가 진행되지 않고 개별 insert로 출력 됩니다.\n하지만 실제 데이터베이스의 로그를 확인해보면 batch insert가 정상적으로 동작하는 것을 확인할 수 있습니다.\n\nSQL Log 확인 방법show variables like &#39;general_log%&#39;; 확인 해서 general_log가 OFF인 경우set global general_log = &#39;ON&#39;; 설정 이후 general_log_file 경로에 로그 파일 확인\n\n\n\n\nVariable_name\nValue\n\n\n\ngeneral_log\nOFF\n\n\ngeneral_log_file\n&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;2eb41ec6a5fe.log\n\n\n연관 관계#1234567891011121314object Books : LongIdTable(&quot;book&quot;) &#123;    val writer = reference(&quot;writer_id&quot;, Writers)    val title = varchar(&quot;title&quot;, 150)    val price = decimal(&quot;price&quot;, 10, 4)    val createdAt = datetime(&quot;created_at&quot;)    val updatedAt = datetime(&quot;updated_at&quot;)&#125;object Writers : LongIdTable(&quot;writer&quot;) &#123;    val name = varchar(&quot;name&quot;, 150)    val email = varchar(&quot;email&quot;, 150)    val createdAt = datetime(&quot;created_at&quot;)    val updatedAt = datetime(&quot;updated_at&quot;)&#125;\n\nreference을 통해서 객체의 연관 관계를 참조할 수 있게 할 수 있습니다.\nJoin#1234567891011121314151617181920212223@Testfun `join`() &#123;    val writerId = insertWriter(&quot;yun&quot;, &quot;yun@asd.com&quot;)[Writers.id].value    (1..5).map &#123;        insertBook(&quot;$it-title&quot;, BigDecimal.TEN, writerId)    &#125;    // SELECT book.id, book.title, book.price, writer.`name`, writer.email FROM book INNER JOIN writer ON writer.id = book.writer_id    (Books innerJoin Writers)        .slice(            Books.id,            Books.title,            Books.price,            Writers.name,            Writers.email,        )        .selectAll()        .forEach &#123;            it.fieldIndex            println(&quot;bookId: $&#123;it[Books.id]&#125;, title: $&#123;it[Books.title]&#125;, writerName: $&#123;it[Writers.name]&#125;, writerEmail: $&#123;it[Writers.email]&#125;&quot;)        &#125;&#125;\n\nDSL 기반으로 조인 SQL로 쉽게 작성할 수 있습니다.\n참고#\nExposed Wiki\n토비의 스프링 3.1, 361 페이지\n\n","dateCreated":"2021-05-20T01:38:18+09:00","dateModified":"2025-02-02T19:27:46+09:00","datePublished":"2021-05-20T01:38:18+09:00","description":"Exposed는 JetBrains에서 만든 Kotlin 언어 기반의 ORM 프레임워크입니다. Exposed는 두 가지 레벨의 데이터베이스 access를 제공합니다.","headline":"Kotlin 기반 경량 ORM Exposed 정리 Part 1","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/exposed/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/exposed/","keywords":"ORM, Kotlin, Exposed"}</script>
    <meta name="description" content="Exposed는 JetBrains에서 만든 Kotlin 언어 기반의 ORM 프레임워크입니다. Exposed는 두 가지 레벨의 데이터베이스 access를 제공합니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Kotlin 기반 경량 ORM Exposed 정리 Part 1">
<meta property="og:url" content="https://cheese10yun.github.io/exposed/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="Exposed는 JetBrains에서 만든 Kotlin 언어 기반의 ORM 프레임워크입니다. Exposed는 두 가지 레벨의 데이터베이스 access를 제공합니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/TIL/master/assets/TransactionSynchronizations.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/62ba5c8fd643af1a9ab8c8bea88043d397591447/exposed-study/docs/images/batch-insert-logger.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/62ba5c8fd643af1a9ab8c8bea88043d397591447/exposed-study/docs/images/mysql-log.png">
<meta property="article:published_time" content="2021-05-19T16:38:18.000Z">
<meta property="article:modified_time" content="2025-02-02T10:27:46.236Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="ORM">
<meta property="article:tag" content="Kotlin">
<meta property="article:tag" content="Exposed">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cheese10yun/TIL/master/assets/TransactionSynchronizations.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    
    
<link rel="stylesheet" href="/assets/css/toc.css">

    
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Kotlin 기반 경량 ORM Exposed 정리 Part 1
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2021-05-20T01:38:18+09:00">
	
		    2021/05/20
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2><span id="ijeon-exposed-poseuting">이전 Exposed 포스팅</span><a href="#ijeon-exposed-poseuting" class="header-anchor">#</a></h2><ul>
<li><a href="https://cheese10yun.github.io/exposed/">Kotlin 기반 경량 ORM Exposed 정리 Part 1</a></li>
<li><a href="https://cheese10yun.github.io/exposed-2/">Kotlin 기반 경량 ORM Exposed 정리 Part 2</a></li>
<li><a href="https://cheese10yun.github.io/exposed-3/">Kotlin 기반 경량 ORM Exposed 정리 Part 3</a></li>
</ul>
<blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/exposed-study">Github</a> 공개되어 있습니다.</p>
</blockquote>
<h2><span id="exposed-ran">Exposed 란 ?</span><a href="#exposed-ran" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/JetBrains/Exposed">Exposed</a>는 JetBrains에서 만든 Kotlin 언어 기반의 ORM 프레임워크입니다. Exposed는 두 가지 레벨의 데이터베이스 access를 제공합니다. SQL을 매핑 한 DSL 방식, 경량화한 DAO 방식을 제공하며 공식적으로 H2, MySQL, MariaDB, Oracle, PostgreSQL, SQL Server, SQLite 데이터베이스를 지원합니다.</p>
<h2><span id="geuraeseo-wae-sseuneun-de">그래서 왜 쓰는 데 ?</span><a href="#geuraeseo-wae-sseuneun-de" class="header-anchor">#</a></h2><p>저는 개인적, 회사 업무에서 <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-jpa">Spring Data JPA</a>를 주로 사용하고 있습니다. JPA가 가져다주는 큰 장점이 많아 적극적으로 사용하고 있지만 <strong>특정 상황에서 하이버네이트의 단점이 있어 이를 보안하기 위해서 Exposed를 사용하고 있습니다.</strong> 해당 내용은 <a href="https://cheese10yun.github.io/jpa-batch-insert/">Batch Insert 성능 향상기 1편 - With JPA</a>, <a href="https://cheese10yun.github.io/spring-batch-batch-insert/">Batch Insert 성능 향상기 2편 - 성능 측정</a>에서 포스팅한 바 있습니다.</p>
<h2><span id="getting-started">Getting Started</span><a href="#getting-started" class="header-anchor">#</a></h2><h3><span id="mysql">MySQL</span><a href="#mysql" class="header-anchor">#</a></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">db_mysql:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">mysql.local</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql/mysql-server:5.7</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">MYSQL_ROOT_HOST:</span> <span class="string">&#x27;%&#x27;</span></span><br><span class="line">            <span class="attr">MYSQL_DATABASE:</span> <span class="string">&#x27;exposed_study&#x27;</span></span><br><span class="line">            <span class="attr">MYSQL_ALLOW_EMPTY_PASSWORD:</span> <span class="string">&#x27;yes&#x27;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;3366:3306&#x27;</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;./volumes/mysql/default:/var/lib/mysql&#x27;</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;mysqld&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--character-set-server=utf8mb4&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--collation-server=utf8mb4_unicode_ci&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>Exposed에서 지원해 주는 MySQL 기반으로 진행하기 위해서 해당 환경을 Docker로 구성합니다.</p>
<h3><span id="gradle">Gradle</span><a href="#gradle" class="header-anchor">#</a></h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation(<span class="string">&quot;mysql:mysql-connector-java&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.jetbrains.exposed:exposed-core:0.31.1&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.jetbrains.exposed:exposed-dao:0.31.1&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.jetbrains.exposed:exposed-jdbc:0.31.1&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.jetbrains.exposed:exposed-java-time:0.31.1&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>필요한 의존성을 추가합니다.</p>
<h3><span id="config">Config</span><a href="#config" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ExposedGettingStarted</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> config = HikariConfig().apply &#123;</span><br><span class="line">        jdbcUrl = <span class="string">&quot;jdbc:mysql://localhost:3366/exposed_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&quot;</span></span><br><span class="line">        driverClassName = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">        username = <span class="string">&quot;root&quot;</span></span><br><span class="line">        password = <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dataSource = HikariDataSource(config)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HikariConfig</code>에 위에서 생성한 MySQL 정보를 입력하여 <code>DataSource</code>를 생성합니다.</p>
<h2><span id="dsl-bangsig">DSL 방식</span><a href="#dsl-bangsig" class="header-anchor">#</a></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Payments : LongIdTable(name = <span class="string">&quot;payment&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> orderId = long(<span class="string">&quot;order_id&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> amount = decimal(<span class="string">&quot;amount&quot;</span>, <span class="number">19</span>, <span class="number">4</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExposedGettingStarted</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `exposed DSL`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connection to MySQL</span></span><br><span class="line">        Database.connect(dataSource)</span><br><span class="line"></span><br><span class="line">        transaction &#123;</span><br><span class="line">            <span class="comment">// Show SQL logging</span></span><br><span class="line">            addLogger(StdOutSqlLogger)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)</span></span><br><span class="line">            SchemaUtils.create(Payments)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// INSERT INTO payment (amount, order_id) VALUES (1, 1)</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            (<span class="number">1.</span><span class="number">.5</span>).map &#123;</span><br><span class="line">                Payments.insert &#123; payments -&gt;</span><br><span class="line">                    payments[amount] = it.toBigDecimal()</span><br><span class="line">                    payments[orderId] = it.toLong()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// UPDATE payment SET amount=0 WHERE payment.amount &gt;= 0</span></span><br><span class="line">            Payments.update(&#123; amount greaterEq BigDecimal.ZERO &#125;)</span><br><span class="line">            &#123;</span><br><span class="line">                it[amount] = BigDecimal.ZERO</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount = 0</span></span><br><span class="line">            <span class="comment">// Payment(amount=1.0000, orderId=1)</span></span><br><span class="line">            Payments.select &#123; amount eq BigDecimal.ZERO &#125;</span><br><span class="line">                .forEach &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DELETE FROM payment WHERE payment.amount &gt;= 1</span></span><br><span class="line">            Payments.deleteWhere &#123; amount greaterEq BigDecimal.ONE &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DROP TABLE IF EXISTS payment</span></span><br><span class="line">            SchemaUtils.drop(Payments)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Payments</code>객체에 테이블 정보를 작성 하여 테이블을 생성하여 Insert, Select, Update, Delete를 하고 테이블을 Drop 합니다. SQL를 매핑한 DSL 방식으로 코틀린 코드 베이스로 SQL을 조작할 수 있습니다.</p>
<h2><span id="dao-bangsig">DAO 방식</span><a href="#dao-bangsig" class="header-anchor">#</a></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Payment</span>(id: EntityID&lt;<span class="built_in">Long</span>&gt;) : LongEntity(id) &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> : LongEntityClass&lt;Payment&gt;(Payments)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> amount <span class="keyword">by</span> Payments.amount</span><br><span class="line">    <span class="keyword">var</span> orderId <span class="keyword">by</span> Payments.orderId</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExposedGettingStarted</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `exposed DAO`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connection to MySQL</span></span><br><span class="line">        Database.connect(dataSource)</span><br><span class="line"></span><br><span class="line">        transaction &#123;</span><br><span class="line">            <span class="comment">// Show SQL logging</span></span><br><span class="line">            addLogger(StdOutSqlLogger)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)</span></span><br><span class="line">            SchemaUtils.create(Payments)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// INSERT INTO payment (amount, order_id) VALUES (1, 1)</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            (<span class="number">1.</span><span class="number">.20</span>).map &#123;</span><br><span class="line">                Payment.new &#123;</span><br><span class="line">                    amount = it.toBigDecimal()</span><br><span class="line">                    orderId = it.toLong()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// UPDATE payment SET amount=0 WHERE id = 1</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            Payment.all()</span><br><span class="line">                .forEach &#123; it.amount = BigDecimal.ZERO &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount &gt;= 1</span></span><br><span class="line">            <span class="comment">// Payment(amount=1.0000, orderId=1)</span></span><br><span class="line">            Payment.find &#123; amount eq BigDecimal.ONE &#125;</span><br><span class="line">                .forEach &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DELETE FROM payment WHERE payment.id = 1</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            Payment.all()</span><br><span class="line">                .forEach &#123; it.delete() &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DROP TABLE IF EXISTS payment</span></span><br><span class="line">            SchemaUtils.drop(Payments)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DSL 객체인 <code>Payments</code> 기반으로 DAO <code>Payment</code>를 객체를 생성합니다. DAO는 <code>payment</code> 테이블에 대한 Data Access Object의 기능을 전담하게 됩니다. Data JPA의 Repository와 비슷한 개념입니다.</p>
<h2><span id="with-spring-boot">With Spring Boot</span><a href="#with-spring-boot" class="header-anchor">#</a></h2><p>Exposed에서는 Spring Boot를 지원하는 <a target="_blank" rel="noopener" href="https://github.com/JetBrains/Exposed/tree/master/exposed-spring-boot-starter">exposed-spring-boot-starter</a> 의존성을 제공하고 있습니다.</p>
<h3><span id="gradle">gradle</span><a href="#gradle" class="header-anchor">#</a></h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation(<span class="string">&quot;org.jetbrains.exposed:exposed-spring-boot-starter:0.31.1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>스프링 부트에서 공식적으로 지원하는 의존성은 아니기 때문에 버전을 명확하게 명시해야 합니다.</p>
<h3><span id="properties">properties</span><a href="#properties" class="header-anchor">#</a></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3366/exposed_study?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;rewriteBatchedStatements=true&amp;logger=Slf4JLogger&amp;profileSQL=false&amp;maxQuerySizeToLog=100000</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">exposed:</span></span><br><span class="line">        <span class="attr">generate-ddl:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#        excluded-packages: com.example.exposedstudy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging.level.Exposed:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p><code>datasource</code>에 대한 설정을 스프링 부트에서 사용하는 방식 그대로 사용할 수 있고 <code>generate-ddl</code> 설정이 활성화되어 있는 경우 데이터베이스 스키마를 생성하고, 특정 스키마를 제외하고 싶은 경우 <code>excluded-packages</code> 설정으로 제외할 수 있습니다. 실제 코드를 보면 매우 단순합니다. <code>logging.level.Exposed: debug</code> 경우 별도의 설정 없이 Show SQL Log를 볼 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(DataSourceAutoConfiguration::class)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ExposedAutoConfiguration</span>(<span class="keyword">private</span> <span class="keyword">val</span> applicationContext: ApplicationContext) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;\$&#123;spring.exposed.excluded-packages:&#125;#&#123;T(java.util.Collections).emptyList()&#125;&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> excludedPackages: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">springTransactionManager</span><span class="params">(datasource: <span class="type">DataSource</span>)</span></span> = SpringTransactionManager(datasource)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(<span class="string">&quot;spring.exposed.generate-ddl&quot;</span>, havingValue = <span class="string">&quot;true&quot;</span>, matchIfMissing = false)</span></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">databaseInitializer</span><span class="params">()</span></span> = DatabaseInitializer(applicationContext, excludedPackages)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">DatabaseInitializer</span>(<span class="keyword">private</span> <span class="keyword">val</span> applicationContext: ApplicationContext, <span class="keyword">private</span> <span class="keyword">val</span> excludedPackages: List&lt;String&gt;) : ApplicationRunner, Ordered &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getOrder</span><span class="params">()</span></span>: <span class="built_in">Int</span> = DATABASE_INITIALIZER_ORDER</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> DATABASE_INITIALIZER_ORDER = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> logger = LoggerFactory.getLogger(javaClass)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">(args: <span class="type">ApplicationArguments</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> exposedTables = discoverExposedTables(applicationContext, excludedPackages)</span><br><span class="line">        logger.info(<span class="string">&quot;Schema generation for tables &#x27;&#123;&#125;&#x27;&quot;</span>, exposedTables.map &#123; it.tableName &#125;)</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;ddl &#123;&#125;&quot;</span>, exposedTables.map &#123; it.ddl &#125;.joinToString())</span><br><span class="line">        SchemaUtils.create(*exposedTables.toTypedArray())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">discoverExposedTables</span><span class="params">(applicationContext: <span class="type">ApplicationContext</span>, excludedPackages: <span class="type">List</span>&lt;<span class="type">String</span>&gt;)</span></span>: List&lt;Table&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> provider = ClassPathScanningCandidateComponentProvider(<span class="literal">false</span>)</span><br><span class="line">    provider.addIncludeFilter(AssignableTypeFilter(Table::<span class="keyword">class</span>.java))</span><br><span class="line">    excludedPackages.forEach &#123; provider.addExcludeFilter(RegexPatternTypeFilter(Pattern.compile(it.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;\\.&quot;</span>) + <span class="string">&quot;.*&quot;</span>))) &#125;</span><br><span class="line">    <span class="keyword">val</span> packages = AutoConfigurationPackages.<span class="keyword">get</span>(applicationContext)</span><br><span class="line">    <span class="keyword">val</span> components = packages.map &#123; provider.findCandidateComponents(it) &#125;.flatten()</span><br><span class="line">    <span class="keyword">return</span> components.map &#123; Class.forName(it.beanClassName).kotlin.objectInstance <span class="keyword">as</span> Table &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>스프링 표현식으로 제외 시킬 <code>excludedPackages</code>를 List로 받고, <code>generate-ddl</code> 여부에 따라 <code>DatabaseInitializer</code> 빈을 등록여부를 결정합니다. 만약 해당 빈을 등록하게 되면 <code>DatabaseInitializer</code> 객체가 <code>ApplicationRunner</code>을 구현하고 있기 때문에 스프링 어플리케이션이 실행하는 경우 <code>run()</code> 메서드에서 스키마를 생성하게 됩니다. (<code>excludedPackages</code>는 제외)</p>
<p><strong><code>run()</code> 메서드에 <code>@Transactional</code> 어노테이션이 있는 것을 볼 수 있습니다. 이것은 <code>spring-transaction</code>모듈을 통해서 <code>TransactionSynchronizationManager</code>를 기반으로 스프링의 트랜잭션 메커니즘을 그대로 사용할 수 있다는 의미 입니다.</strong></p>
<blockquote>
<p>스프링의 트랜잭션 동기화 메커니즘<br><img src="https://raw.githubusercontent.com/cheese10yun/TIL/master/assets/TransactionSynchronizations.png"><br><a target="_blank" rel="noopener" href="http://m.yes24.com/goods/detail/7516911">토비의 스프링 3.1, 361 페이지</a><br>스프링은 위와 같은 방식으로 트랜잭션 동기화를 진행합니다. 해당 방식은 트랜잭션을 시작하기 위해 만든 Connection 오브젝트를 특별한 저장소에 보관해두고, 이후에 호출되는 메서드에서 저장된 Connection을 가져다가 사용합니다.</p>
</blockquote>
<h2><span id="testing-in-spring-boot">Testing in Spring Boot</span><a href="#testing-in-spring-boot" class="header-anchor">#</a></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)</span></span><br><span class="line"><span class="meta">@ActiveProfiles(<span class="string">&quot;test&quot;</span>)</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ExposedTestSupport</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExposedGettingStartedInSpringBoot</span> : <span class="type">ExposedTestSupport</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `exposed DAO`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connection to MySQL</span></span><br><span class="line">        <span class="comment">// Database.connect(dataSource) 스프링 Bean의 DataSource를 사용하기 때문에 주석</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// transaction &#123; 스프링 @Transactional 으로 트랜잭션을 시작하기 때문에 주석</span></span><br><span class="line">        <span class="comment">// Show SQL logging</span></span><br><span class="line">        <span class="comment">// addLogger(StdOutSqlLogger)  logging.level.Exposed: debug 으로 Show SQL logging 확인</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)</span></span><br><span class="line">        <span class="comment">//  SchemaUtils.create(Payments)  generate-ddl: true 으로 스키마 생성</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// INSERT INTO payment (amount, order_id) VALUES (1, 1)</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        (<span class="number">1.</span><span class="number">.20</span>).map &#123;</span><br><span class="line">            Payment.new &#123;</span><br><span class="line">                amount = it.toBigDecimal()</span><br><span class="line">                orderId = it.toLong()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// UPDATE payment SET amount=0 WHERE id = 1</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Payment.all()</span><br><span class="line">            .forEach &#123; it.amount = BigDecimal.ZERO &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount &gt;= 1</span></span><br><span class="line">        <span class="comment">// Payment(amount=1.0000, orderId=1)</span></span><br><span class="line">        Payment.find &#123; amount eq BigDecimal.ONE &#125;</span><br><span class="line">            .forEach &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DELETE FROM payment WHERE payment.id = 1</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Payment.all()</span><br><span class="line">            .forEach &#123; it.delete() &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DROP TABLE IF EXISTS payment</span></span><br><span class="line">        <span class="comment">// SchemaUtils.drop(Payments)</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> `exposed DSL`<span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connection to MySQL</span></span><br><span class="line">        <span class="comment">// Database.connect(dataSource) 스프링 Bean의 DataSource를 사용하기 때문에 주석</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// transaction &#123; 스프링 @Transactional 으로 트랜잭션을 시작하기 때문에 주석</span></span><br><span class="line">        <span class="comment">// Show SQL logging</span></span><br><span class="line">        <span class="comment">// addLogger(StdOutSqlLogger)  logging.level.Exposed: debug 으로 Show SQL logging 확인</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CREATE TABLE IF NOT EXISTS payment (id BIGINT AUTO_INCREMENT PRIMARY KEY, order_id BIGINT NOT NULL, amount DECIMAL(19, 4) NOT NULL)</span></span><br><span class="line">        <span class="comment">//  SchemaUtils.create(Payments)  generate-ddl: true 으로 스키마 생성</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// INSERT INTO payment (amount, order_id) VALUES (1, 1)</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        (<span class="number">1.</span><span class="number">.5</span>).map &#123;</span><br><span class="line">            Payments.insert &#123; payments -&gt;</span><br><span class="line">                payments[amount] = it.toBigDecimal()</span><br><span class="line">                payments[orderId] = it.toLong()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// UPDATE payment SET amount=0 WHERE payment.amount &gt;= 0</span></span><br><span class="line">        Payments.update(&#123; amount greaterEq BigDecimal.ZERO &#125;)</span><br><span class="line">        &#123;</span><br><span class="line">            it[amount] = BigDecimal.ZERO</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SELECT payment.id, payment.order_id, payment.amount FROM payment WHERE payment.amount = 0</span></span><br><span class="line">        <span class="comment">// Payment(amount=1.0000, orderId=1)</span></span><br><span class="line">        Payments.select &#123; amount eq BigDecimal.ZERO &#125;</span><br><span class="line">            .forEach &#123; println(it) &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DELETE FROM payment WHERE payment.amount &gt;= 1</span></span><br><span class="line">        Payments.deleteWhere &#123; amount greaterEq BigDecimal.ONE &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DROP TABLE IF EXISTS payment</span></span><br><span class="line">        <span class="comment">// SchemaUtils.drop(Payments)</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataSource</code>는 스프링 Bean을 사용하기 때문에 제거했으며, <code>transaction &#123; ... &#125;</code>으로 트랜잭션을 시작했던 코드를 스프링의 <code>@Transactional</code>으로 대체했습니다. 또한 <code>SchemaUtils.create(Payments)</code>으로 스키마를 생성했던 부분을 <code>generate-ddl: true</code> 속성 파일로 대체했습니다. 그리고 <code>ExposedTestSupport</code> 객체에 <code>@Transactional</code>가 있어 테스트 코드의 최종 데이터는 모두 Rollback을 진행하게 됩니다. <strong>Spring 환경에서 Exposed를 사용하게 되면 보다 간결하게 사용 가능합니다.</strong></p>
<h2><span id="simhwa">심화</span><a href="#simhwa" class="header-anchor">#</a></h2><h3><span id="batch-insert">batch insert</span><a href="#batch-insert" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `batch insert`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">data</span> = (<span class="number">1.</span><span class="number">.10</span>).map &#123; it &#125;</span><br><span class="line">    Books.batchInsert(</span><br><span class="line">        <span class="keyword">data</span>,</span><br><span class="line">        ignore = <span class="literal">false</span>,</span><br><span class="line">        shouldReturnGeneratedValues = <span class="literal">false</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">this</span>[Books.writer] = <span class="number">1L</span></span><br><span class="line">        <span class="keyword">this</span>[Books.title] = <span class="string">&quot;<span class="variable">$it</span>-title&quot;</span></span><br><span class="line">        <span class="keyword">this</span>[Books.price] = it.toBigDecimal()</span><br><span class="line">        <span class="keyword">this</span>[Books.createdAt] = LocalDateTime.now()</span><br><span class="line">        <span class="keyword">this</span>[Books.updatedAt] = LocalDateTime.now()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Exposed</code>는 <code>batchInsert()</code> 메서드를 지원하기 때문에 쉽게 batch insert를 진행할 수 있습니다. Mysql의 경우 JDBC 드라이버에 <code>rewriteBatchedStatements=true</code> 속성을 반드시 입력해야 batch insert가 가능합니다. <code>shouldReturnGeneratedValues</code> 값을 false로 지정하면 <code>auto_increment</code>으로 증가된 ID 값을 가져오지 않기에 성능이 향상될 수 있습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/62ba5c8fd643af1a9ab8c8bea88043d397591447/exposed-study/docs/images/batch-insert-logger.png"></p>
<p>로그에 출력되는 SQL은 batch insert가 진행되지 않고 개별 insert로 출력 됩니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/62ba5c8fd643af1a9ab8c8bea88043d397591447/exposed-study/docs/images/mysql-log.png"><br><strong>하지만 실제 데이터베이스의 로그를 확인해보면 batch insert가 정상적으로 동작하는 것을 확인할 수 있습니다.</strong></p>
<blockquote>
<p>SQL Log 확인 방법<br><code>show variables like &#39;general_log%&#39;;</code> 확인 해서 <code>general_log</code>가 OFF인 경우<br><code>set global general_log = &#39;ON&#39;;</code> 설정 이후 <code>general_log_file</code> 경로에 로그 파일 확인</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">Variable_name</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">general_log</td>
<td align="left">OFF</td>
</tr>
<tr>
<td align="left">general_log_file</td>
<td align="left">&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;2eb41ec6a5fe.log</td>
</tr>
</tbody></table>
<h3><span id="yeongwan-gwangye">연관 관계</span><a href="#yeongwan-gwangye" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Books : LongIdTable(<span class="string">&quot;book&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> writer = reference(<span class="string">&quot;writer_id&quot;</span>, Writers)</span><br><span class="line">    <span class="keyword">val</span> title = varchar(<span class="string">&quot;title&quot;</span>, <span class="number">150</span>)</span><br><span class="line">    <span class="keyword">val</span> price = decimal(<span class="string">&quot;price&quot;</span>, <span class="number">10</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">val</span> createdAt = datetime(<span class="string">&quot;created_at&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> updatedAt = datetime(<span class="string">&quot;updated_at&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> Writers : LongIdTable(<span class="string">&quot;writer&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> name = varchar(<span class="string">&quot;name&quot;</span>, <span class="number">150</span>)</span><br><span class="line">    <span class="keyword">val</span> email = varchar(<span class="string">&quot;email&quot;</span>, <span class="number">150</span>)</span><br><span class="line">    <span class="keyword">val</span> createdAt = datetime(<span class="string">&quot;created_at&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> updatedAt = datetime(<span class="string">&quot;updated_at&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reference을 통해서 객체의 연관 관계를 참조할 수 있게 할 수 있습니다.</p>
<h3><span id="join">Join</span><a href="#join" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> `join`<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> writerId = insertWriter(<span class="string">&quot;yun&quot;</span>, <span class="string">&quot;yun@asd.com&quot;</span>)[Writers.id].value</span><br><span class="line">    (<span class="number">1.</span><span class="number">.5</span>).map &#123;</span><br><span class="line">        insertBook(<span class="string">&quot;<span class="variable">$it</span>-title&quot;</span>, BigDecimal.TEN, writerId)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SELECT book.id, book.title, book.price, writer.`name`, writer.email FROM book INNER JOIN writer ON writer.id = book.writer_id</span></span><br><span class="line">    (Books innerJoin Writers)</span><br><span class="line">        .slice(</span><br><span class="line">            Books.id,</span><br><span class="line">            Books.title,</span><br><span class="line">            Books.price,</span><br><span class="line">            Writers.name,</span><br><span class="line">            Writers.email,</span><br><span class="line">        )</span><br><span class="line">        .selectAll()</span><br><span class="line">        .forEach &#123;</span><br><span class="line">            it.fieldIndex</span><br><span class="line">            println(<span class="string">&quot;bookId: <span class="subst">$&#123;it[Books.id]&#125;</span>, title: <span class="subst">$&#123;it[Books.title]&#125;</span>, writerName: <span class="subst">$&#123;it[Writers.name]&#125;</span>, writerEmail: <span class="subst">$&#123;it[Writers.email]&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>DSL 기반으로 조인 SQL로 쉽게 작성할 수 있습니다.</p>
<h2><span id="camgo">참고</span><a href="#camgo" class="header-anchor">#</a></h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/JetBrains/Exposed/wiki">Exposed Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://m.yes24.com/goods/detail/7516911">토비의 스프링 3.1, 361 페이지</a></li>
</ul>

            


        </div>
    </div>
    <!-- Table of Contents -->
    <div id="toc-container">
        <div class="toc-title">목차</div>
        <ul id="toc-list"></ul>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Exposed/" rel="tag">Exposed</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Kotlin/" rel="tag">Kotlin</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/ORM/" rel="tag">ORM</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-reader-performance/"
                    data-tooltip="Spring Batch Reader 성능 분석 및 측정 part 1"
                    aria-label="이전: Spring Batch Reader 성능 분석 및 측정 part 1"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-transaction/"
                    data-tooltip="Spring 레플리케이션 트랜잭션 처리 방식"
                    aria-label="다음: Spring 레플리케이션 트랜잭션 처리 방식"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/exposed/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/exposed/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        

                
                    <!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                

            
        
    </div>
</article>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2026 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-reader-performance/"
                    data-tooltip="Spring Batch Reader 성능 분석 및 측정 part 1"
                    aria-label="이전: Spring Batch Reader 성능 분석 및 측정 part 1"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-transaction/"
                    data-tooltip="Spring 레플리케이션 트랜잭션 처리 방식"
                    aria-label="다음: Spring 레플리케이션 트랜잭션 처리 방식"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/exposed/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/exposed/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/exposed/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/exposed/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>



<script src="/assets/js/toc.js"></script>


<!--SCRIPTS END-->


    




    </body>
</html>

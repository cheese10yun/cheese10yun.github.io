
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM" />
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>HTTP Client 책임 분리하기 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"\n해당 코드는 Github 공개되어 있습니다.\n\n일반적으로 특정 요구사항을 만족하기 위해서는 다른 서비스들과의 통신을 통하여 진행합니다. 가장 대표적인 통신은 HTTP으로 쉽고 간결하게 연결이 가능하여 많이 사용합니다.\nHTTP Client를 개발할 때 적절한 책임과 역할을 부여하는 방법에 대해서 이번 포스팅에서 다루려고 합니다. 보편적으로 이렇게 책임과 역할을 나누는 것이 좋다는 것이지 모든 프로젝트에 알맞은 패턴이라고 주장하는 것은 아닙니다.\nHTTP Client Code#HTTP Client 라이브러리는 Fuel를 사용했습니다. 특정 라이브러리에 대한 부분이 핵심이 아니기 때문에 다른 클라이언트를 사용하는 경우에도 무방합니다. 개인적으로 사용법이 직관적이고 코틀린 베이스이기 때문에 코틀린으로 프로젝트를 진행 중이다면 Fuel을 추천드립니다.\n코드 흐름#책 예약 서비스인 Book Reservation Service로 책에 대한 예약만을 진행하고 책에 대한 정보는 Book Service에서 HTTP 통신을 통해 진행한다고 가정하겠습니다.\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546@Serviceclass BookReservationService() &#123;    private val BOOK_SERVICE_HOST: String = &quot;http://book-service.copm&quot;    fun doReservation(bookId: Long, userId: Long) &#123;        val book = &quot;$BOOK_SERVICE_HOST/api/v1/books/$bookId&quot;            .httpGet()            .responseObject&lt;Book&gt;()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)                &#125;            &#125;            .get()        val bookReservation = BookReservation(            bookId = book.id,            bookStatus = book.status,            userId = userId        )        // bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영        // Book Service API에 책 상태 업데이트        &quot;$BOOK_SERVICE_HOST/api/v1/books&quot;            .httpPost()            .header(Headers.CONTENT_TYPE, &quot;application/json&quot;)            .jsonBody(                &quot;&quot;&quot;                    &#123;                      &quot;status&quot;: &quot;RESERVATION&quot;                    &#125;                &quot;&quot;&quot;.trimIndent()            )            .response()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;Book Status Failed&quot;)                &#125;            &#125;            .get()    &#125;&#125;\n\n책 예약을 하기 위해 책에 대한 정보 조회, 책에 대한 상태 업데이트를 Book Service를 통해 HTTP 통신을 진행한다는 코드입니다. 해당 코드는 무엇이 문제일까요? doReservation 메서드가 너무 많은 일을 하고 책임 또한 많이 가져간다고 생각합니다. 책 조회, 책 상태 업데이트에 대한 실패, 성공 등등 모든 책임이 부여되어 있고, 해당 케이스에 대한 구현이 doReservation 메서드 외에는 테스트할 수 없는 블랙박스가 되어 버린다고 생각합니다.\n이런 식의 고도한 책임 부여 현상은 테스트 코드를 작성 시 자연스럽게 알게 되어 리팩토링하게 되는 부분이 있습니다. 해당 포스팅에 중요 논점은 아니지만 테스트 코드에 아주 큰 장점으로 코드에 대한 피드백을 가장 빠르게 개발자에게 제공한다고 생각합니다.\n다시 본론으로 들어가서 가장 쉬운 해결책은 BookClient 코드를 분리하는 것입니다.\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859@Serviceclass BookReservationService2() &#123;    //    private val BOOK_SERVICE_HOST: String = &quot;http://book-service.copm&quot;    val bookClient = BookClient()    fun doReservation(bookId: Long, userId: Long) &#123;        val book = bookClient.getBook(bookId)        val bookReservation = BookReservation(            bookId = boo.id,            bookStatus = boo.status,            userId = userId        )        // bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영                // Book Service API에 책 상태 업데이트        bookClient.updateBookStatus(status = &quot;RESERVATION&quot;)    &#125;&#125;class BookClient(    private val host: String = &quot;http://book-service.copm&quot;) &#123;    fun getBook(bookId: Long) =        &quot;$host/api/v1/books/$bookId&quot;            .httpGet()            .responseObject&lt;Book&gt;()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)                &#125;            &#125;            .get()    fun updateBookStatus(        status: String    ) =        &quot;$host/api/v1/books&quot;            .httpPost()            .header(Headers.CONTENT_TYPE, &quot;application/json&quot;)            .jsonBody(                &quot;&quot;&quot;                    &#123;                      &quot;status&quot;: &quot;$status&quot;                    &#125;                &quot;&quot;&quot;.trimIndent()            )            .response()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;Book Status Failed&quot;)                &#125;            &#125;            .get()&#125;\n\n가장 일반적인 패턴으로 Book HTTP 통신을 위한 HTTP Client를 객체로 분리하는 것입니다. 그 결과 Book HTTP 통신에 대한 책임을 doReservation 메서드로부터 분리되긴 하지만 위 코드도 책임이 적절하게 부여됐다고 생각하지는 않습니다.\nJPA Repositroy 패턴#우선 우리가 자주 사용하는 JPA Repositroy에 대한 설명 드리겠습니다.\n12345678@Serviceclass BookReservationFindService(    private val bookReservationRepository: BookReservationRepository) &#123;    fun findById(id: Long): BookReservation &#123;        return bookReservationRepository.findById(id).orElseThrow &#123; throw IllegalArgumentException(&quot;id: $id Not found&quot;) &#125;    &#125;&#125;\n\nJPA Repositroy에서 findById 메서드에서 특별히 예외를 발생시키지는 않습니다. 조회가 끝난 이후에 예외 발생 여부는 서비스 레이어로 넘어가게 됩니다. 없는 경우 어떤 예외를 발생할지는 서비스 레이어에서 결정하며, 그 결정은 비즈니스 로직에 의해 결정하게 됩니다.\n\n우리는 각 계층 별로 책임과 역할을 나누고 본인의 계층에서는 본인의 책임과 역할을 진행하고 상대적으로 Low 레이어에서는 비즈니스에 대한 로직이 없고, High 레이어에서는 비즈니스에 대한 로직이 들어가게 됩니다.\nJPA Repositroy &#x3D;&#x3D; HTTP Client#\n저는 JPA Repositroy와 HTTP Client에 대한 레이어가 동일하다고 생각합니다. 위에서 언급했듯이상대적으로 Low 레이어에서는 본인이 담당하는 Low 레벨에 대한 책임만을 수행하며, 비즈니스에 대한 책임은 서비스 레이어에서 진행하는 것이 바람직합니다.\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697@Serviceclass BookReservationService3(    private val objectMapper: ObjectMapper) &#123;    //    private val BOOK_SERVICE_HOST: String = &quot;http://book-service.copm&quot;    val bookClient = BookClient(objectMapper = objectMapper)    fun doReservation(bookId: Long, userId: Long) &#123;        val responseBook = bookClient.getBook(bookId)        if (responseBook.first.not()) &#123;            throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)        &#125;        val book = responseBook.second!!        val bookReservation = BookReservation(            bookId = book.id,            bookStatus = book.status,            userId = userId        )        // bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영        // Book Service API에 책 상태 업데이트        val bookStatusUpdateResponse = bookClient.updateBookStatus(status = &quot;RESERVATION&quot;)        if (bookStatusUpdateResponse.first.not()) &#123;            throw IllegalArgumentException(&quot;book status update failed&quot;)        &#125;    &#125;&#125;class BookClient(    private val host: String = &quot;http://book-service.com&quot;,    private val objectMapper: ObjectMapper) &#123;    fun getBook(bookId: Long) =        &quot;$host/api/v1/books/$bookId&quot;            .httpGet()            .responseObject&lt;Book&gt;()// 비즈니스 예외는 서비스 레이어에서 책임 진다.//            .third//            .onError &#123;//                if (it.response.isSuccessful.not()) &#123;//                    throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)//                &#125;//            &#125;//            .get()//            .second            .run &#123;                Pair(                    this.second.isSuccessful,                    when &#123;                        this.second.isSuccessful -&gt; this.third.get()                        else -&gt; null                    &#125;                )            &#125;    fun updateBookStatus(        status: String    ) =        &quot;$host/api/v1/books&quot;            .httpPost()            .header(Headers.CONTENT_TYPE, &quot;application/json&quot;)            .jsonBody(                &quot;&quot;&quot;                    &#123;                      &quot;status&quot;: &quot;$status&quot;                    &#125;                &quot;&quot;&quot;.trimIndent()            )// 비즈니스 예외는 서비스 레이어에서 책임 진다.//            .response()//            .third//            .onError &#123;//                if (it.response.isSuccessful.not()) &#123;//                    throw IllegalArgumentException(&quot;Book Status Failed&quot;)//                &#125;//            &#125;            .response()            .run &#123;                Pair(                    second.isSuccessful,                    when &#123;                        second.isSuccessful -&gt; null                        else -&gt; &#123;                            objectMapper.readValue(                                String(second.body().toByteArray()),                                ErrorResponse::class.java                            )                        &#125;                    &#125;                )            &#125;    &#125;&#125;\n\nHTTP Client에서는 본인 레이어에 해당하는 역할인 HTTP 통신에 대한 요청&#x2F;응답에 대한 책임과 역할을 갖게 하며 HTTP 응답&#x2F;요청에 대한 비즈니스 판단은 서비스 레이어에서 진행합니다. 또한 JPA Repositroy에서는 본인의 책임 영역인 SQL Exception(Low 레벨) 발생시키듯이, HTTP Client도 HTTP 통신에 대한 Low 레벨에 해당하는 예외를 발생시켜 본인 계층의 책임을 다합니다.\nHTTP Client에서 예외를 발생시키면#1234567891011121314151617181920212223242526272829303132333435363738394041424344454647class Book &#123;    fun updateStatus(bookId: Long, status: String)&#123;        &quot;$BOOK_SERVICE_HOST/api/v1/books/$bookId&quot;            .httpPost()            .header(Headers.CONTENT_TYPE, &quot;application/json&quot;)            .jsonBody(                &quot;&quot;&quot;                    &#123;                      &quot;status&quot;: &quot;$status&quot;                    &#125;                &quot;&quot;&quot;.trimIndent()            )            .response()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;Book Status Failed&quot;)                &#125;            &#125;            .get()    &#125;        fun getBook(bookId: Long) =        &quot;$host/api/v1/books/$bookId&quot;            .httpGet()            .responseObject&lt;Book&gt;()            .third            .onError &#123;                if (it.response.isSuccessful.not()) &#123;                    throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)                &#125;            &#125;            .get()            .second&#125;class BookBulkStatusUpdate() &#123;    fun update(bookId: Long, bookStatus: String) &#123;        BookClient()            .updateBookStatus(bookId, bookStatus)                // 벌크 업데이트 진행 여부를 데이터베이스에 기록하는 로직...    &#125;&#125;\n위와 같이 예외를 발생시키고 해당 업데이트에 대한 기록을 저장하는 로직이 있다고 가정하면 위 코드는 200응답을 받지 못하면 예외가 발생하여 로직이 종료됩니다. 물론 try catch를 통해서 예외를 잡고 로직을 이어가면 가능은 하지만 이런 식의 구조는 좋은 코드의 흐름이라고는 생각하지 않습니다. 그러기 때문에 HTTP Client에 대한 책임은 요청&#x2F;응답에 대한 책임만 부여하여, 요청&#x2F;응답이 변경되지 않는 이상 HTTP Client의 코드에 변경이 없도록 하는 것이 바람직합니다.\n조회 또한 마찬가지입니다. 조회해서 없는 경우 새로 Book를 생성할 수 있고, 아니면 기본 Book을 응답할 수 있습니다. 이 영역은 비즈니스 영역이기 때문에 HTTP Client에서는 해당 부분을 관여하지 않는 것이 바람직합니다.\n비즈니스 코드가 있는 경우 HTTP Client를 한 번더 감싸야 하는가?#HTTP Client에서는 응답&#x2F;요청에 대한 책임과 역할만을 부여한다면, 비즈니스 로직이 필요한 경우에는 반드시 서비스로 감싸야 하는가라는 의문이 생깁니다.\n12345678910111213class BookClient &#123;    fun registerBook(        bookName: String,        bookCode: String,        publisher: String    )&#123;        // bookCode가 publisher에 맞게 적절하게 생생했는지 비즈니스 유효성 검증이 필요...        &quot;$host/api/v1/books&quot;            .httpPost()            .header(Headers.CONTENT_TYPE, &quot;application/json&quot;)            .jsonBody(&quot;...&quot;)    &#125;&#125;\n위 코드처럼 책을 등록하는 경우 bookCode가 출판사에 맞게 생성된 코드인지 검증이 필요한 경우 등등 요청을 보내야 하는 경우 특정 값에 대해서 유효성 검증, 해당 값을 조합하여 새로운 값을 생성 등등 다양한 것들이 경우가 있을 수 있습니다.\n1234567891011121314151617class BookClientRegistrationService() &#123;    private val bookClient = BookClient()    fun register(        bookName: String,        bookCode: String,        publisher: String    ) &#123;        // 필요한 비즈니스 로직 진행 ...        // 로직 진행 이후 HTTP Client 호출        bookClient.registerBook(            bookName = bookName,            bookCode = bookCode,            publisher = publisher,        )    &#125;&#125;\n그런 경우에는 이렇게 HTTP Client를 한 번 더 감싸 BookClientRegistrationService라는 서비스 영역에서 비즈니스 요구사항에 맞는 책임을 부여하는 것이 적절해 보입니다. 하지만 단순하게 null, empty 검증 정도로 단순한 검증이라면 서비스 영역을 별도로 만들지는 않을 거 같습니다.\n","dateCreated":"2022-01-29T00:00:00+09:00","dateModified":"2025-02-02T13:43:50+09:00","datePublished":"2022-01-29T00:00:00+09:00","description":"일반적으로 특정 요구사항을 만족하기 위해서는 다른 서비스들과의 통신을 통하여 진행합니다. 가장 대표적인 통신은 HTTP으로 쉽고 간결하게 연결이 가능하여 많이 사용합니다.","headline":"HTTP Client 책임 분리하기","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/http-client/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/http-client/","keywords":"Spring"}</script>
    <meta name="description" content="일반적으로 특정 요구사항을 만족하기 위해서는 다른 서비스들과의 통신을 통하여 진행합니다. 가장 대표적인 통신은 HTTP으로 쉽고 간결하게 연결이 가능하여 많이 사용합니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="HTTP Client 책임 분리하기">
<meta property="og:url" content="https://cheese10yun.github.io/http-client/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="일반적으로 특정 요구사항을 만족하기 위해서는 다른 서비스들과의 통신을 통하여 진행합니다. 가장 대표적인 통신은 HTTP으로 쉽고 간결하게 연결이 가능하여 많이 사용합니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/msa-error-response/docs/http-jpa-layar.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/msa-error-response/docs/http-client-layar.png">
<meta property="article:published_time" content="2022-01-28T15:00:00.000Z">
<meta property="article:modified_time" content="2025-02-02T04:43:50.929Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/msa-error-response/docs/http-jpa-layar.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            HTTP Client 책임 분리하기
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2022-01-29T00:00:00+09:00">
	
		    2022/01/29
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/msa-error-response">Github</a> 공개되어 있습니다.</p>
</blockquote>
<p>일반적으로 특정 요구사항을 만족하기 위해서는 다른 서비스들과의 통신을 통하여 진행합니다. 가장 대표적인 통신은 HTTP으로 쉽고 간결하게 연결이 가능하여 많이 사용합니다.</p>
<p>HTTP Client를 개발할 때 적절한 책임과 역할을 부여하는 방법에 대해서 이번 포스팅에서 다루려고 합니다. 보편적으로 이렇게 책임과 역할을 나누는 것이 좋다는 것이지 모든 프로젝트에 알맞은 패턴이라고 주장하는 것은 아닙니다.</p>
<h2><span id="http-client-code">HTTP Client Code</span><a href="#http-client-code" class="header-anchor">#</a></h2><p>HTTP Client 라이브러리는 <a target="_blank" rel="noopener" href="https://github.com/kittinunf/fuel">Fuel</a>를 사용했습니다. 특정 라이브러리에 대한 부분이 핵심이 아니기 때문에 다른 클라이언트를 사용하는 경우에도 무방합니다. 개인적으로 사용법이 직관적이고 코틀린 베이스이기 때문에 코틀린으로 프로젝트를 진행 중이다면 <a target="_blank" rel="noopener" href="https://github.com/kittinunf/fuel">Fuel</a>을 추천드립니다.</p>
<h2><span id="kodeu-heureum">코드 흐름</span><a href="#kodeu-heureum" class="header-anchor">#</a></h2><p>책 예약 서비스인 Book Reservation Service로 책에 대한 예약만을 진행하고 책에 대한 정보는 Book Service에서 HTTP 통신을 통해 진행한다고 가정하겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookReservationService</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> BOOK_SERVICE_HOST: String = <span class="string">&quot;http://book-service.copm&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doReservation</span><span class="params">(bookId: <span class="type">Long</span>, userId: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> book = <span class="string">&quot;<span class="variable">$BOOK_SERVICE_HOST</span>/api/v1/books/<span class="variable">$bookId</span>&quot;</span></span><br><span class="line">            .httpGet()</span><br><span class="line">            .responseObject&lt;Book&gt;()</span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;bookId: <span class="variable">$bookId</span> not found&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> bookReservation = BookReservation(</span><br><span class="line">            bookId = book.id,</span><br><span class="line">            bookStatus = book.status,</span><br><span class="line">            userId = userId</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Book Service API에 책 상태 업데이트</span></span><br><span class="line">        <span class="string">&quot;<span class="variable">$BOOK_SERVICE_HOST</span>/api/v1/books&quot;</span></span><br><span class="line">            .httpPost()</span><br><span class="line">            .header(Headers.CONTENT_TYPE, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            .jsonBody(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;status&quot;: &quot;RESERVATION&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">            )</span><br><span class="line">            .response()</span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Book Status Failed&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>책 예약을 하기 위해 책에 대한 정보 조회, 책에 대한 상태 업데이트를 Book Service를 통해 HTTP 통신을 진행한다는 코드입니다. 해당 코드는 무엇이 문제일까요? <code>doReservation</code> 메서드가 너무 많은 일을 하고 책임 또한 많이 가져간다고 생각합니다. 책 조회, 책 상태 업데이트에 대한 실패, 성공 등등 모든 책임이 부여되어 있고, 해당 케이스에 대한 구현이 <code>doReservation</code> 메서드 외에는 테스트할 수 없는 블랙박스가 되어 버린다고 생각합니다.</p>
<p>이런 식의 고도한 책임 부여 현상은 테스트 코드를 작성 시 자연스럽게 알게 되어 리팩토링하게 되는 부분이 있습니다. 해당 포스팅에 중요 논점은 아니지만 테스트 코드에 아주 큰 장점으로 코드에 대한 피드백을 가장 빠르게 개발자에게 제공한다고 생각합니다.</p>
<p>다시 본론으로 들어가서 가장 쉬운 해결책은 BookClient 코드를 분리하는 것입니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookReservationService2</span>() &#123;</span><br><span class="line">    <span class="comment">//    private val BOOK_SERVICE_HOST: String = &quot;http://book-service.copm&quot;</span></span><br><span class="line">    <span class="keyword">val</span> bookClient = BookClient()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doReservation</span><span class="params">(bookId: <span class="type">Long</span>, userId: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> book = bookClient.getBook(bookId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> bookReservation = BookReservation(</span><br><span class="line">            bookId = boo.id,</span><br><span class="line">            bookStatus = boo.status,</span><br><span class="line">            userId = userId</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Book Service API에 책 상태 업데이트</span></span><br><span class="line">        bookClient.updateBookStatus(status = <span class="string">&quot;RESERVATION&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookClient</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> host: String = <span class="string">&quot;http://book-service.copm&quot;</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getBook</span><span class="params">(bookId: <span class="type">Long</span>)</span></span> =</span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books/<span class="variable">$bookId</span>&quot;</span></span><br><span class="line">            .httpGet()</span><br><span class="line">            .responseObject&lt;Book&gt;()</span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;bookId: <span class="variable">$bookId</span> not found&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateBookStatus</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        status: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> =</span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books&quot;</span></span><br><span class="line">            .httpPost()</span><br><span class="line">            .header(Headers.CONTENT_TYPE, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            .jsonBody(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;status&quot;: &quot;<span class="variable">$status</span>&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">            )</span><br><span class="line">            .response()</span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Book Status Failed&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>가장 일반적인 패턴으로 Book HTTP 통신을 위한 HTTP Client를 객체로 분리하는 것입니다. 그 결과 Book HTTP 통신에 대한 책임을 <code>doReservation</code> 메서드로부터 분리되긴 하지만 위 코드도 책임이 적절하게 부여됐다고 생각하지는 않습니다.</p>
<h2><span id="jpa-repositroy-paeteon">JPA Repositroy 패턴</span><a href="#jpa-repositroy-paeteon" class="header-anchor">#</a></h2><p>우선 우리가 자주 사용하는 JPA Repositroy에 대한 설명 드리겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookReservationFindService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookReservationRepository: BookReservationRepository</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">findById</span><span class="params">(id: <span class="type">Long</span>)</span></span>: BookReservation &#123;</span><br><span class="line">        <span class="keyword">return</span> bookReservationRepository.findById(id).orElseThrow &#123; <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;id: <span class="variable">$id</span> Not found&quot;</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JPA Repositroy에서 <code>findById</code> 메서드에서 특별히 예외를 발생시키지는 않습니다. 조회가 끝난 이후에 예외 발생 여부는 서비스 레이어로 넘어가게 됩니다. 없는 경우 어떤 예외를 발생할지는 서비스 레이어에서 결정하며, 그 결정은 비즈니스 로직에 의해 결정하게 됩니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/msa-error-response/docs/http-jpa-layar.png"></p>
<p>우리는 각 계층 별로 책임과 역할을 나누고 본인의 계층에서는 본인의 책임과 역할을 진행하고 상대적으로 Low 레이어에서는 비즈니스에 대한 로직이 없고, High 레이어에서는 비즈니스에 대한 로직이 들어가게 됩니다.</p>
<h2><span id="jpa-repositroy-x3d-x3d-http-client">JPA Repositroy &#x3D;&#x3D; HTTP Client</span><a href="#jpa-repositroy-x3d-x3d-http-client" class="header-anchor">#</a></h2><p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/msa-error-response/docs/http-client-layar.png"></p>
<p>저는 JPA Repositroy와 HTTP Client에 대한 레이어가 동일하다고 생각합니다. 위에서 언급했듯이<br>상대적으로 Low 레이어에서는 본인이 담당하는 Low 레벨에 대한 책임만을 수행하며, 비즈니스에 대한 책임은 서비스 레이어에서 진행하는 것이 바람직합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookReservationService3</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> objectMapper: ObjectMapper</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">//    private val BOOK_SERVICE_HOST: String = &quot;http://book-service.copm&quot;</span></span><br><span class="line">    <span class="keyword">val</span> bookClient = BookClient(objectMapper = objectMapper)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doReservation</span><span class="params">(bookId: <span class="type">Long</span>, userId: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> responseBook = bookClient.getBook(bookId)</span><br><span class="line">        <span class="keyword">if</span> (responseBook.first.not()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;bookId: <span class="variable">$bookId</span> not found&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> book = responseBook.second!!</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> bookReservation = BookReservation(</span><br><span class="line">            bookId = book.id,</span><br><span class="line">            bookStatus = book.status,</span><br><span class="line">            userId = userId</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// bookReservationRepository.save(bookReservation) JPA를 사용한다고 가정하고 책 예약 반영</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Book Service API에 책 상태 업데이트</span></span><br><span class="line">        <span class="keyword">val</span> bookStatusUpdateResponse = bookClient.updateBookStatus(status = <span class="string">&quot;RESERVATION&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bookStatusUpdateResponse.first.not()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;book status update failed&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookClient</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> host: String = <span class="string">&quot;http://book-service.com&quot;</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> objectMapper: ObjectMapper</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getBook</span><span class="params">(bookId: <span class="type">Long</span>)</span></span> =</span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books/<span class="variable">$bookId</span>&quot;</span></span><br><span class="line">            .httpGet()</span><br><span class="line">            .responseObject&lt;Book&gt;()</span><br><span class="line"><span class="comment">// 비즈니스 예외는 서비스 레이어에서 책임 진다.</span></span><br><span class="line"><span class="comment">//            .third</span></span><br><span class="line"><span class="comment">//            .onError &#123;</span></span><br><span class="line"><span class="comment">//                if (it.response.isSuccessful.not()) &#123;</span></span><br><span class="line"><span class="comment">//                    throw IllegalArgumentException(&quot;bookId: $bookId not found&quot;)</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            .get()</span></span><br><span class="line"><span class="comment">//            .second</span></span><br><span class="line">            .run &#123;</span><br><span class="line">                Pair(</span><br><span class="line">                    <span class="keyword">this</span>.second.isSuccessful,</span><br><span class="line">                    <span class="keyword">when</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.second.isSuccessful -&gt; <span class="keyword">this</span>.third.<span class="keyword">get</span>()</span><br><span class="line">                        <span class="keyword">else</span> -&gt; <span class="literal">null</span></span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateBookStatus</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        status: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> =</span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books&quot;</span></span><br><span class="line">            .httpPost()</span><br><span class="line">            .header(Headers.CONTENT_TYPE, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            .jsonBody(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;status&quot;: &quot;<span class="variable">$status</span>&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">            )</span><br><span class="line"><span class="comment">// 비즈니스 예외는 서비스 레이어에서 책임 진다.</span></span><br><span class="line"><span class="comment">//            .response()</span></span><br><span class="line"><span class="comment">//            .third</span></span><br><span class="line"><span class="comment">//            .onError &#123;</span></span><br><span class="line"><span class="comment">//                if (it.response.isSuccessful.not()) &#123;</span></span><br><span class="line"><span class="comment">//                    throw IllegalArgumentException(&quot;Book Status Failed&quot;)</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            .response()</span><br><span class="line">            .run &#123;</span><br><span class="line">                Pair(</span><br><span class="line">                    second.isSuccessful,</span><br><span class="line">                    <span class="keyword">when</span> &#123;</span><br><span class="line">                        second.isSuccessful -&gt; <span class="literal">null</span></span><br><span class="line">                        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                            objectMapper.readValue(</span><br><span class="line">                                String(second.body().toByteArray()),</span><br><span class="line">                                ErrorResponse::<span class="keyword">class</span>.java</span><br><span class="line">                            )</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HTTP Client에서는 본인 레이어에 해당하는 역할인 HTTP 통신에 대한 요청&#x2F;응답에 대한 책임과 역할을 갖게 하며 HTTP 응답&#x2F;요청에 대한 비즈니스 판단은 서비스 레이어에서 진행합니다. 또한 JPA Repositroy에서는 본인의 책임 영역인 SQL Exception(Low 레벨) 발생시키듯이, HTTP Client도 HTTP 통신에 대한 Low 레벨에 해당하는 예외를 발생시켜 본인 계층의 책임을 다합니다.</p>
<h2><span id="http-clienteseo-yeoereul-balsaengsikimyeon">HTTP Client에서 예외를 발생시키면</span><a href="#http-clienteseo-yeoereul-balsaengsikimyeon" class="header-anchor">#</a></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateStatus</span><span class="params">(bookId: <span class="type">Long</span>, status: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">        <span class="string">&quot;<span class="variable">$BOOK_SERVICE_HOST</span>/api/v1/books/<span class="variable">$bookId</span>&quot;</span></span><br><span class="line">            .httpPost()</span><br><span class="line">            .header(Headers.CONTENT_TYPE, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            .jsonBody(</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;status&quot;: &quot;<span class="variable">$status</span>&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">            )</span><br><span class="line">            .response()</span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Book Status Failed&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getBook</span><span class="params">(bookId: <span class="type">Long</span>)</span></span> =</span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books/<span class="variable">$bookId</span>&quot;</span></span><br><span class="line">            .httpGet()</span><br><span class="line">            .responseObject&lt;Book&gt;()</span><br><span class="line"></span><br><span class="line">            .third</span><br><span class="line">            .onError &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.response.isSuccessful.not()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;bookId: <span class="variable">$bookId</span> not found&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="keyword">get</span>()</span><br><span class="line">            .second</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookBulkStatusUpdate</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(bookId: <span class="type">Long</span>, bookStatus: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        BookClient()</span><br><span class="line">            .updateBookStatus(bookId, bookStatus)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 벌크 업데이트 진행 여부를 데이터베이스에 기록하는 로직...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 예외를 발생시키고 해당 업데이트에 대한 기록을 저장하는 로직이 있다고 가정하면 위 코드는 200응답을 받지 못하면 예외가 발생하여 로직이 종료됩니다. 물론 try catch를 통해서 예외를 잡고 로직을 이어가면 가능은 하지만 이런 식의 구조는 좋은 코드의 흐름이라고는 생각하지 않습니다. 그러기 때문에 HTTP Client에 대한 책임은 요청&#x2F;응답에 대한 책임만 부여하여, 요청&#x2F;응답이 변경되지 않는 이상 HTTP Client의 코드에 변경이 없도록 하는 것이 바람직합니다.</p>
<p>조회 또한 마찬가지입니다. 조회해서 없는 경우 새로 Book를 생성할 수 있고, 아니면 기본 Book을 응답할 수 있습니다. 이 영역은 비즈니스 영역이기 때문에 HTTP Client에서는 해당 부분을 관여하지 않는 것이 바람직합니다.</p>
<h2><span id="bijeuniseu-kodeuga-issneun-gyeongu-http-clientreul-han-beondeo-gamssaya-haneunga">비즈니스 코드가 있는 경우 HTTP Client를 한 번더 감싸야 하는가?</span><a href="#bijeuniseu-kodeuga-issneun-gyeongu-http-clientreul-han-beondeo-gamssaya-haneunga" class="header-anchor">#</a></h2><p>HTTP Client에서는 응답&#x2F;요청에 대한 책임과 역할만을 부여한다면, 비즈니스 로직이 필요한 경우에는 반드시 서비스로 감싸야 하는가라는 의문이 생깁니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">registerBook</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        bookName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bookCode: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        publisher: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>&#123;</span><br><span class="line">        <span class="comment">// bookCode가 publisher에 맞게 적절하게 생생했는지 비즈니스 유효성 검증이 필요...</span></span><br><span class="line">        <span class="string">&quot;<span class="variable">$host</span>/api/v1/books&quot;</span></span><br><span class="line">            .httpPost()</span><br><span class="line">            .header(Headers.CONTENT_TYPE, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            .jsonBody(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드처럼 책을 등록하는 경우 bookCode가 출판사에 맞게 생성된 코드인지 검증이 필요한 경우 등등 요청을 보내야 하는 경우 특정 값에 대해서 유효성 검증, 해당 값을 조합하여 새로운 값을 생성 등등 다양한 것들이 경우가 있을 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BookClientRegistrationService</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bookClient = BookClient()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        bookName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bookCode: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        publisher: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="comment">// 필요한 비즈니스 로직 진행 ...</span></span><br><span class="line">        <span class="comment">// 로직 진행 이후 HTTP Client 호출</span></span><br><span class="line">        bookClient.registerBook(</span><br><span class="line">            bookName = bookName,</span><br><span class="line">            bookCode = bookCode,</span><br><span class="line">            publisher = publisher,</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그런 경우에는 이렇게 HTTP Client를 한 번 더 감싸 BookClientRegistrationService라는 서비스 영역에서 비즈니스 요구사항에 맞는 책임을 부여하는 것이 적절해 보입니다. 하지만 단순하게 null, empty 검증 정도로 단순한 검증이라면 서비스 영역을 별도로 만들지는 않을 거 같습니다.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Spring/" rel="tag">Spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-http-page-item-reader/"
                    data-tooltip="Spring Batch HTTP Page Item Reader"
                    aria-label="이전: Spring Batch HTTP Page Item Reader"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/error-response-2/"
                    data-tooltip="MSA 환경에서 Error Response 서버로 전달하기"
                    aria-label="다음: MSA 환경에서 Error Response 서버로 전달하기"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/http-client/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/http-client/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        

                
                    <!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                

            
        
    </div>
</article>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2026 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-batch-http-page-item-reader/"
                    data-tooltip="Spring Batch HTTP Page Item Reader"
                    aria-label="이전: Spring Batch HTTP Page Item Reader"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/error-response-2/"
                    data-tooltip="MSA 환경에서 Error Response 서버로 전달하기"
                    aria-label="다음: MSA 환경에서 Error Response 서버로 전달하기"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/http-client/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/http-client/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/http-client/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/http-client/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>

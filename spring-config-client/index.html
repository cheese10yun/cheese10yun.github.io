
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM" />
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>Spring Cloud Config &amp; Cloud Bus 정리 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"\n해당 코드는 Github에서 확인할 수 있으며 Spring Config Server 정리 글과 이어지는 글입니다.  \n\nSpring Config Server 정리를 통해서 Config Server에 대해서 알아봤습니다. 이번 포스팅에서는 Config Client를 알아보겠습니다.\n각 서비스 애플리케이션은 해당 애플리케이션이 구동시 Config Server에 자신의 Config의 설정 파일을 읽어 오며, 애플리케이션이 구동 중에도 Config 설정을 변경해도 애플리케이션 재시작 없이 해당 변경 내용을 반영할 수 있습니다.\n\nConfig Client 구성#1234dependencies &#123;    implementation(&quot;org.springframework.cloud:spring-cloud-starter-config&quot;)    implementation(&quot;org.springframework.cloud:spring-cloud-starter-bus-kafka&quot;)&#125;\n\nconfig: Config Client 의존성\nbus-kafka: Cloud Bus를 이용해서 변경사항을 모든 인스턴스에게 전달하는 경우 사용\n\n1234567891011121314151617181920212223server:    port: 8181spring:    application:        name: order-service # (1)    kafka:        bootstrap-servers: localhost:29092 # (2)    config:        import: &quot;optional:configserver:http://localhost:8888&quot; # (3)management:    endpoints:        web:            exposure:                include:                    - &quot;*&quot; # (4)                    # - &quot;refresh&quot; # 위 &#x27;*&#x27;  으로 전체를 공개 해서 주석                    # - &quot;bus-refresh&quot; # 위 &#x27;*&#x27;  으로 전체를 공개 해서 주석    endpoint:        refresh:            enabled: true\n\n\n(1): 애플리케이션 이름을 지정 spring.application.name 값을 기준으로 Config Repositroy 저장소에 있는 Config 파일을 인식해서 가져오기 때문에 반드시 두 값을 일치 시켜야 합니다.\nspring.application.name=order-service의 경우 order-service-&#123;evn&#125;.yml을 Config 파일로 인식함\n\n\n(2): 변경사항을 전파하는 카프카 주소 작성\n(3): Config Server 주소 작성, optional:configserver:&#123;address&#125;으로 작성\n(4): actuator의 속성을 *으로 전체 공개, 실제 운영 애플리케이션에서는 필요한 부분만 공개해야 합니다.\n\n123456789101112# order-service.ymlmessage:    profile: &quot;default&quot;    server-name: &quot;Config Server&quot;# order-service-sandbox.ymlmessage:    profile: &quot;sandbox&quot;# order-service-production.ymlmessage:    profile: &quot;production&quot;\nConfig Server 저장소 Gtihub Repository에는 위와 같은 yml이 구성되어 있습니다.\n애플리케이션 구동#spring.application.name=order-service, profile=local 설정인 애플리케이션 구동했을 때는의 경우로 설명드리겠습니다. 애플리케이션이 구동할 때 Config Server에게 자신의 Config 설정을 가져옵니다. 위 이미지에서는 1, 2번 항목에 해당합니다. 자세히 코드 레벨로 살펴보겠습니다.\n서버가 구동하면 /&#123;name&#125;/&#123;profiles:.*[^-].*&#125; API를 호출합니다. 해당 API 코드는 아래와 같습니다.\n12345# EnvironmentController.class@RequestMapping(path = &quot;/&#123;name&#125;/&#123;profiles:.*[^-].*&#125;&quot;,   produces = EnvironmentMediaType.V2_JSON)public Environment defaultLabelIncludeOrigin(@PathVariable String name, @PathVariable String profiles) &#123;    return getEnvironment(name, profiles, null, true);&#125;\n\n\nspring.application.name=order-service, profile=local 설정을 기반으로 Config Server의 API를 호출하여 자신의 애플리케이션을 가져옵니다.\nOrder Application 설정 확인#12345678910@RestController@RequestMapping(&quot;/orders&quot;)class OrderApi(    @Value(&quot;\\$&#123;message.profile&#125;&quot;) val profile: String) &#123;    @GetMapping(&quot;/profile&quot;)    fun getRepoProfile(): String &#123;        return profile    &#125;&#125;\n\nmessage.profile 설정 확인을 하기 위해서 간단한 API를 만들어 보고 테스트를 진행해 보겠습니다.\n12345678910111213GET http://localhost:8181/orders/profileHTTP/1.1 200 Content-Type: application/jsonContent-Length: 5Date: Sun, 01 Aug 2021 13:15:56 GMTKeep-Alive: timeout=60Connection: keep-alivelocalResponse code: 200; Time: 198ms; Content length: 5 bytes\n\nConfig 서버를 통해서 가져온 값이 정상적으로 order application에 가져온 것을 확인할 수 있습니다.\n\nConfig Server를 통해해서 가져온 Confg 값을 다시 살펴보겠습니다. message.profile=local은 정상적으로 가져온 것을 확인할 수 있으며, local 프로필에는 message.server-name값이 없기 때문에 해당 값은 default config인 order-service.yml값의 message.server-name=Config Server의 설정값을 사용합니다. 즉 default 값도 확인해야 하기 때문에 profile, default profile을 조회합니다.\n재시작 없이 Config 변경#Config Server의 가장 큰 장점 중 하나는 서버가 재시작 없이 Config 설정 파일을 바꿀 수 있다는 점입니다. 해당 기능에 대해서 살펴보겠습니다.\nactuator 설정을 통해서 공개된 refresh API를 통해서 애플리케이션 구동 중에 Config 설정을 변경할 수 있습니다.\n1234567891011121314151617181920212223242526272829303132333435GET http://192.168.0.5:8585/actuatorHTTP/1.1 200 Content-Type: application/vnd.spring-boot.actuator.v3+jsonContent-Length: 435Date: Sat, 07 Aug 2021 00:53:20 GMTKeep-Alive: timeout=60Connection: keep-alive&#123;  &quot;_links&quot;: &#123;    &quot;self&quot;: &#123;      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator&quot;,      &quot;templated&quot;: false    &#125;,    &quot;info&quot;: &#123;      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/info&quot;,      &quot;templated&quot;: false    &#125;,    &quot;refresh&quot;: &#123;      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/refresh&quot;,      &quot;templated&quot;: false    &#125;,    &quot;busrefresh-destinations&quot;: &#123;      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/busrefresh/&#123;*destinations&#125;&quot;,      &quot;templated&quot;: true    &#125;,    &quot;busrefresh&quot;: &#123;      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/busrefresh&quot;,      &quot;templated&quot;: false    &#125;  &#125;&#125;Response code: 200; Time: 78ms; Content length: 435 bytes\n\nGET https://localhost:8585/actuator refresh, busrefresh API가 공개되어 있는 것을 확인할 수 있습니다. refresh 부터 설명드리겠습니다.\n1234567891011@RestController@RequestMapping(&quot;/orders&quot;)@RefreshScope // (1)class OrderApi(    @Value(&quot;\\$&#123;message.profile&#125;&quot;) val profile: String) &#123;    @GetMapping(&quot;/profile&quot;)    fun getRepoProfile(): String &#123;        return profile    &#125;&#125;\n123# order-service-local.ymlmessage:    profile: &quot;new local&quot; # (2)\n\n\n(1) @RefreshScope 어노테이션을 추가를 합니다.\n(2) Config Repositroy에 있는 Config 설정을 위처럼 변경해서 Push 합니다.\n(3) POST /actuator/refresh API를 호출하여 변경 내용을 반영합니다.\n(4) GET /orders/profile을 호출하여 변경 내용은 확인합니다.\n\n123456789101112131415POST http://localhost:8585/actuator/refreshHTTP/1.1 200 Content-Type: application/vnd.spring-boot.actuator.v3+jsonContent-Length: 43Date: Sun, 01 Aug 2021 14:22:38 GMTKeep-Alive: timeout=60Connection: keep-alive[  &quot;config.client.version&quot;,  &quot;message.profile&quot;]Response code: 200; Time: 6374ms; Content length: 43 bytes\n\nPOST /actuator/refresh API를 호출하면 변경한 propertie의 key 값을 확인할 수 있습니다.\n123456789101112GET http://localhost:8181/orders/profileHTTP/1.1 200 Content-Type: application/jsonContent-Length: 10Date: Sun, 01 Aug 2021 14:22:57 GMTKeep-Alive: timeout=60111Connection: keep-alivewnew localResponse code: 200; Time: 186ms; Content length: 10 bytes\n\nGET /orders/profile을 호출하면 위에서 변경한 내용을 확인할 수 있습니다. 서버가 구동 중이라도 Config Server를 이용해서 설정 파일을 동적으로 변경할 수 있습니다.\n동일한 설정이 로컬 환경에도 있는 경우에는?#12345678910# Config Server# order-service-local.yml message:    profile: &quot;new local2&quot;# local project# application-local.ymlmessage:    profile: &quot;new local local&quot;\n\n로컬 프로퍼티와, Config 프로퍼티가 중복될 경우 어느 것을 우선되는지 확인해 보겠습니다.\n123456789101112GET http://192.168.0.5:8585/orders/profileHTTP/1.1 200 Content-Type: text/plain;charset=UTF-8Content-Length: 10Date: Sat, 07 Aug 2021 01:04:59 GMTKeep-Alive: timeout=60Connection: keep-alivenew local2Response code: 200; Time: 45ms; Content length: 10 bytes\n\nGET http://192.168.0.5:8585/orders/profile을 호출해보면 본인 설정보다 Config Server 설정이 우선되는 것을 확인할 수 있습니다. 해당 설정을 로컬에도 가지고 있는 경우에는 이 점을 유의해야 합니다.\n서버가 여러대의 경우 Cloud Bus#\n일반적으로 서비스 인스턴스들은 2대 이상으로 구성하게 됩니다. 그러기 때문에 /actuator/refresh 호출을 인스턴스 수에 따라서 N 번 해야 하며, 컨테이너 환경에서는 해당 작업은 더 복잡합니다. 이러한 문제는 Spring Cloud Bus를 이용해서 Kafka으로 브로드캐스팅 방식으로 변경사항을 모든 인스턴스에게 전달하는 방식으로 해결할 수 있습니다.\n메시지 플랫폼으로는 spring-cloud-starter-bus-amqp, spring-cloud-starter-bus-kafka을 선택할 수 있습니다. bus-amqp는 Rabbit MQ를 사용하고, kafka는 Kafka를 사용합니다. 본 예제는 Kafka를 기준으로 설명드리겠습니다.\nKafka Docker#123456789101112131415161718192021222324# docker-compose.yamlversion: &#x27;3&#x27;services:  zookeeper:    image: confluentinc/cp-zookeeper:latest    environment:      ZOOKEEPER_CLIENT_PORT: 2181      ZOOKEEPER_TICK_TIME: 2000    ports:      - 22181:2181    kafka:    image: confluentinc/cp-kafka:latest    depends_on:      - zookeeper    ports:      - 29092:29092    environment:      KAFKA_BROKER_ID: 1      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1\n\n1$ docker-compose up -d\n위 처럼 카프카 도커를 구성해서 도커를 구동시킵니다.\n카프카 이벤트로 변경사항 전파#1234567891011121314# application.ymlspring:    application:        name: order-service    kafka:        bootstrap-servers: localhost:29092management:    endpoints:        web:            exposure:                include:                    - &quot;refresh&quot;                    - &quot;bus-refresh&quot;\n위에서 구성한 카프카 설정, actuator으로 bus-refresh을 노출시키는 설정을 완료합니다. 해당 설정을 완료했다면 인스턴스를 2대를 각각 다른 포트로 애플리케이션을 구동시킵니다.\n\n포스팅에서는 Eureka를 통해서 order-service를 랜덤 포트를 이용해서 2대를 구성했습니다. 포트가 각기 다르게 profile local으로 띄우기만 하면 되니 굳이 유레카에 해당 서버를 등록시킬 필요는 없습니다. 인스턴스가 2개를 띄웠다는 부분을 표시하기 위해서 이미지를 첨부했습니다.\n각각 서버에서 /orders/profile을 호출해서 message.profile를 확인해보겠습니다.\n123456789101112131415161718192021222324252627GET http://192.168.0.5:58704/orders/profileHTTP/1.1 200 Content-Type: text/plain;charset=UTF-8Content-Length: 10Date: Sat, 07 Aug 2021 04:36:43 GMTKeep-Alive: timeout=60Connection: keep-alivenew local2Response code: 200; Time: 59ms; Content length: 10 bytesGET http://192.168.0.5:59013/orders/profileHTTP/1.1 200 Content-Type: text/plain;charset=UTF-8Content-Length: 10Date: Sat, 07 Aug 2021 04:36:30 GMTKeep-Alive: timeout=60Connection: keep-alivenew local2Response code: 200; Time: 56ms; Content length: 10 bytes\n\n로컬 프로퍼티를 정상적으로 인식하는 것을 확인할 수 있습니다. 그렇다면 Config Server의 프로퍼티를 message.profile=&quot;local&quot;으로 Push 한 이후 포트 59013 서버 1대에 /actuator/busrefresh를 호출하겠습니다.\n1234567891011POST http://192.168.0.5:59013/actuator/busrefreshHTTP/1.1 204 Date: Sat, 07 Aug 2021 04:42:33 GMTKeep-Alive: timeout=60Connection: keep-alive&lt;Response body is empty&gt;Response code: 204; Time: 6842ms; Content length: 0 bytes\n정상적으로 호출이 완료되었으면 59013, 58704 서버를 모두 확인해보겠습니다.\n1234567891011121314151617181920212223242526GET http://192.168.0.5:58704/orders/profileHTTP/1.1 200 Content-Type: text/plain;charset=UTF-8Content-Length: 5Date: Sat, 07 Aug 2021 04:42:47 GMTKeep-Alive: timeout=60Connection: keep-alivelocalResponse code: 200; Time: 47ms; Content length: 5 bytesGET http://192.168.0.5:59013/orders/profileHTTP/1.1 200 Content-Type: text/plain;charset=UTF-8Content-Length: 5Date: Sat, 07 Aug 2021 04:43:05 GMTKeep-Alive: timeout=60Connection: keep-alivelocalResponse code: 200; Time: 151ms; Content length: 5 bytes\n59013 서버에 이벤트를 반영했지만 58704 서버에도 해당 내용이 전파된 것을 확인할 수 있습니다.\n이벤트 확인#\n\n카프카 로그를 보면 정상적으로 이벤트가 발행된 부분을 확인할 수 있으며, 위에서 지정한 토픽 이름인 $&#123;spring.application.name&#125;config-bus-refesh-event을 확인할 수 있습니다. 만약 코드 레벨에서 Config 변경 이벤트 구독 받아 후속 작업을 하고 싶은 경우에는 @EventListener으로 RefreshRemoteApplicationEvent 이벤트를 구독 받아 처리할 수 있습니다.\n123456789@EventListenerfun onRefreshRemoteEvent(event: RefreshRemoteApplicationEvent) &#123;    log.info(&quot;Event....&quot;)    log.info(event.id)    log.info(event.source.toString())    log.info(event.originService)    log.info(event.destinationService)    log.info(&quot;Event....&quot;)&#125;\n\n\n디버깅 모드로 실제 값들을 확인할 수 있습니다.\n","dateCreated":"2021-08-07T00:00:00+09:00","dateModified":"2025-02-02T13:35:24+09:00","datePublished":"2021-08-07T00:00:00+09:00","description":"Spring Config Server 정리를 통해서 Config Server에 대해서 알아봤습니다. 이번 포스팅에서는 Config Client를 알아보겠습니다.","headline":"Spring Cloud Config & Cloud Bus 정리","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/spring-config-client/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/spring-config-client/","keywords":"Spring, Event, MSA"}</script>
    <meta name="description" content="Spring Config Server 정리를 통해서 Config Server에 대해서 알아봤습니다. 이번 포스팅에서는 Config Client를 알아보겠습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring Cloud Config &amp; Cloud Bus 정리">
<meta property="og:url" content="https://cheese10yun.github.io/spring-config-client/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="Spring Config Server 정리를 통해서 Config Server에 대해서 알아봤습니다. 이번 포스팅에서는 Config Client를 알아보겠습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-server1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-debug.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-debug-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-client-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/eureka.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/kafka-log.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/kafka-matric.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/bus-event.png">
<meta property="article:published_time" content="2021-08-06T15:00:00.000Z">
<meta property="article:modified_time" content="2025-02-02T04:35:24.603Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="Event">
<meta property="article:tag" content="MSA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-server1.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    
    
<link rel="stylesheet" href="/assets/css/toc.css">

    
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Spring Cloud Config &amp; Cloud Bus 정리
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2021-08-07T00:00:00+09:00">
	
		    2021/08/07
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/spring-msa">Github</a>에서 확인할 수 있으며 <a href="https://cheese10yun.github.io/spring-config-server">Spring Config Server 정리</a> 글과 이어지는 글입니다.  </p>
</blockquote>
<p><a href="https://cheese10yun.github.io/spring-config-server/">Spring Config Server 정리</a>를 통해서 Config Server에 대해서 알아봤습니다. 이번 포스팅에서는 Config Client를 알아보겠습니다.</p>
<p>각 서비스 애플리케이션은 해당 애플리케이션이 구동시 Config Server에 자신의 Config의 설정 파일을 읽어 오며, <strong>애플리케이션이 구동 중에도 Config 설정을 변경해도 애플리케이션 재시작 없이 해당 변경 내용을 반영할 수 있습니다.</strong></p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-server1.png"></p>
<h2><span id="config-client-guseong">Config Client 구성</span><a href="#config-client-guseong" class="header-anchor">#</a></h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation(<span class="string">&quot;org.springframework.cloud:spring-cloud-starter-config&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.springframework.cloud:spring-cloud-starter-bus-kafka&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>config: Config Client 의존성</li>
<li>bus-kafka: Cloud Bus를 이용해서 변경사항을 모든 인스턴스에게 전달하는 경우 사용</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">application:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">order-service</span> <span class="comment"># (1)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">        <span class="attr">bootstrap-servers:</span> <span class="string">localhost:29092</span> <span class="comment"># (2)</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">        <span class="attr">import:</span> <span class="string">&quot;optional:configserver:http://localhost:8888&quot;</span> <span class="comment"># (3)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">    <span class="attr">endpoints:</span></span><br><span class="line">        <span class="attr">web:</span></span><br><span class="line">            <span class="attr">exposure:</span></span><br><span class="line">                <span class="attr">include:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span> <span class="comment"># (4)</span></span><br><span class="line">                    <span class="comment"># - &quot;refresh&quot; # 위 &#x27;*&#x27;  으로 전체를 공개 해서 주석</span></span><br><span class="line">                    <span class="comment"># - &quot;bus-refresh&quot; # 위 &#x27;*&#x27;  으로 전체를 공개 해서 주석</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>(1): 애플리케이션 이름을 지정 <code>spring.application.name</code> 값을 기준으로 <strong>Config Repositroy 저장소에 있는 Config 파일을 인식해서 가져오기 때문에 반드시 두 값을 일치 시켜야 합니다.</strong><ul>
<li><code>spring.application.name=order-service</code>의 경우 <code>order-service-&#123;evn&#125;.yml</code>을 Config 파일로 인식함</li>
</ul>
</li>
<li>(2): 변경사항을 전파하는 카프카 주소 작성</li>
<li>(3): Config Server 주소 작성, <code>optional:configserver:&#123;address&#125;</code>으로 작성</li>
<li>(4): <code>actuator</code>의 속성을 <code>*</code>으로 전체 공개, <strong>실제 운영 애플리케이션에서는 필요한 부분만 공개해야 합니다.</strong></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order-service.yml</span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line">    <span class="attr">server-name:</span> <span class="string">&quot;Config Server&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># order-service-sandbox.yml</span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;sandbox&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># order-service-production.yml</span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;production&quot;</span></span><br></pre></td></tr></table></figure>
<p>Config Server 저장소 Gtihub Repository에는 위와 같은 <code>yml</code>이 구성되어 있습니다.</p>
<h2><span id="aepeulrikeisyeon-gudong">애플리케이션 구동</span><a href="#aepeulrikeisyeon-gudong" class="header-anchor">#</a></h2><p><code>spring.application.name=order-service</code>, <code>profile=local</code> 설정인 애플리케이션 구동했을 때는의 경우로 설명드리겠습니다. 애플리케이션이 구동할 때 Config Server에게 자신의 Config 설정을 가져옵니다. 위 이미지에서는 1, 2번 항목에 해당합니다. 자세히 코드 레벨로 살펴보겠습니다.</p>
<p>서버가 구동하면 <code>/&#123;name&#125;/&#123;profiles:.*[^-].*&#125;</code> API를 호출합니다. 해당 API 코드는 아래와 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># EnvironmentController.class</span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/&#123;name&#125;/&#123;profiles:.*[^-].*&#125;&quot;,   produces = EnvironmentMediaType.V2_JSON)</span></span><br><span class="line"><span class="keyword">public</span> Environment <span class="title function_">defaultLabelIncludeOrigin</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profiles)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getEnvironment(name, profiles, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-debug.png"></p>
<p><code>spring.application.name=order-service</code>, <code>profile=local</code> 설정을 기반으로 Config Server의 API를 호출하여 자신의 애플리케이션을 가져옵니다.</p>
<h3><span id="order-application-seoljeong-hwagin">Order Application 설정 확인</span><a href="#order-application-seoljeong-hwagin" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;\$&#123;message.profile&#125;&quot;</span>)</span> <span class="keyword">val</span> profile: String</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/profile&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getRepoProfile</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> profile</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>message.profile</code> 설정 확인을 하기 위해서 간단한 API를 만들어 보고 테스트를 진행해 보겠습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8181/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 5</span><br><span class="line">Date: Sun, 01 Aug 2021 13:15:56 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">local</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 198ms; Content length: 5 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Config 서버를 통해서 가져온 값이 정상적으로 order application에 가져온 것을 확인할 수 있습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-debug-1.png"></p>
<p>Config Server를 통해해서 가져온 Confg 값을 다시 살펴보겠습니다. <code>message.profile=local</code>은 정상적으로 가져온 것을 확인할 수 있으며, local 프로필에는 <code>message.server-name</code>값이 없기 때문에 해당 값은 default config인 <code>order-service.yml</code>값의 <code>message.server-name=Config Server</code>의 설정값을 사용합니다. <strong>즉 default 값도 확인해야 하기 때문에 profile, default profile을 조회합니다.</strong></p>
<h2><span id="jaesijag-eobsi-config-byeongyeong">재시작 없이 Config 변경</span><a href="#jaesijag-eobsi-config-byeongyeong" class="header-anchor">#</a></h2><p>Config Server의 가장 큰 장점 중 하나는 서버가 재시작 없이 Config 설정 파일을 바꿀 수 있다는 점입니다. 해당 기능에 대해서 살펴보겠습니다.</p>
<p><code>actuator</code> 설정을 통해서 공개된 <code>refresh</code> API를 통해서 애플리케이션 구동 중에 Config 설정을 변경할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.0.5:8585/actuator</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/vnd.spring-boot.actuator.v3+json</span><br><span class="line">Content-Length: 435</span><br><span class="line">Date: Sat, 07 Aug 2021 00:53:20 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_links&quot;: &#123;</span><br><span class="line">    &quot;self&quot;: &#123;</span><br><span class="line">      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator&quot;,</span><br><span class="line">      &quot;templated&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;info&quot;: &#123;</span><br><span class="line">      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/info&quot;,</span><br><span class="line">      &quot;templated&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;refresh&quot;: &#123;</span><br><span class="line">      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/refresh&quot;,</span><br><span class="line">      &quot;templated&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;busrefresh-destinations&quot;: &#123;</span><br><span class="line">      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/busrefresh/&#123;*destinations&#125;&quot;,</span><br><span class="line">      &quot;templated&quot;: true</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;busrefresh&quot;: &#123;</span><br><span class="line">      &quot;href&quot;: &quot;http://192.168.0.5:8585/actuator/busrefresh&quot;,</span><br><span class="line">      &quot;templated&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 78ms; Content length: 435 bytes</span><br></pre></td></tr></table></figure>

<p><code>GET https://localhost:8585/actuator</code> <code>refresh</code>, <code>busrefresh</code> API가 공개되어 있는 것을 확인할 수 있습니다. <code>refresh</code> 부터 설명드리겠습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/orders&quot;</span>)</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">// (1)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderApi</span>(</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;\$&#123;message.profile&#125;&quot;</span>)</span> <span class="keyword">val</span> profile: String</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/profile&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getRepoProfile</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> profile</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order-service-local.yml</span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;new local&quot;</span> <span class="comment"># (2)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>(1) <code>@RefreshScope</code> 어노테이션을 추가를 합니다.</li>
<li>(2) Config Repositroy에 있는 Config 설정을 위처럼 변경해서 Push 합니다.</li>
<li>(3) <code>POST /actuator/refresh</code> API를 호출하여 변경 내용을 반영합니다.</li>
<li>(4) <code>GET /orders/profile</code>을 호출하여 변경 내용은 확인합니다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:8585/actuator/refresh</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/vnd.spring-boot.actuator.v3+json</span><br><span class="line">Content-Length: 43</span><br><span class="line">Date: Sun, 01 Aug 2021 14:22:38 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &quot;config.client.version&quot;,</span><br><span class="line">  &quot;message.profile&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 6374ms; Content length: 43 bytes</span><br></pre></td></tr></table></figure>

<p><code>POST /actuator/refresh</code> API를 호출하면 변경한 propertie의 key 값을 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8181/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 10</span><br><span class="line">Date: Sun, 01 Aug 2021 14:22:57 GMT</span><br><span class="line">Keep-Alive: timeout=60111</span><br><span class="line">Connection: keep-alivew</span><br><span class="line"></span><br><span class="line">new local</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 186ms; Content length: 10 bytes</span><br></pre></td></tr></table></figure>

<p><code>GET /orders/profile</code>을 호출하면 위에서 변경한 내용을 확인할 수 있습니다. 서버가 구동 중이라도 Config Server를 이용해서 설정 파일을 동적으로 변경할 수 있습니다.</p>
<h2><span id="dongilhan-seoljeongi-rokeol-hwangyeongedo-issneun-gyeongueneun">동일한 설정이 로컬 환경에도 있는 경우에는?</span><a href="#dongilhan-seoljeongi-rokeol-hwangyeongedo-issneun-gyeongueneun" class="header-anchor">#</a></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Config Server</span></span><br><span class="line"><span class="comment"># order-service-local.yml </span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;new local2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># local project</span></span><br><span class="line"><span class="comment"># application-local.yml</span></span><br><span class="line"><span class="attr">message:</span></span><br><span class="line">    <span class="attr">profile:</span> <span class="string">&quot;new local local&quot;</span></span><br></pre></td></tr></table></figure>

<p>로컬 프로퍼티와, Config 프로퍼티가 중복될 경우 어느 것을 우선되는지 확인해 보겠습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.0.5:8585/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 10</span><br><span class="line">Date: Sat, 07 Aug 2021 01:04:59 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">new local2</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 45ms; Content length: 10 bytes</span><br></pre></td></tr></table></figure>

<p><strong><code>GET http://192.168.0.5:8585/orders/profile</code>을 호출해보면 본인 설정보다 Config Server 설정이 우선되는 것을 확인할 수 있습니다. 해당 설정을 로컬에도 가지고 있는 경우에는 이 점을 유의해야 합니다.</strong></p>
<h2><span id="seobeoga-yeoreodaeyi-gyeongu-cloud-bus">서버가 여러대의 경우 Cloud Bus</span><a href="#seobeoga-yeoreodaeyi-gyeongu-cloud-bus" class="header-anchor">#</a></h2><p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/config-client-1.png"></p>
<p>일반적으로 서비스 인스턴스들은 2대 이상으로 구성하게 됩니다. 그러기 때문에 <code>/actuator/refresh</code> 호출을 인스턴스 수에 따라서 N 번 해야 하며, 컨테이너 환경에서는 해당 작업은 더 복잡합니다. 이러한 문제는 <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-bus/reference/html/">Spring Cloud Bus</a>를 이용해서 Kafka으로 브로드캐스팅 방식으로 변경사항을 모든 인스턴스에게 전달하는 방식으로 해결할 수 있습니다.</p>
<p>메시지 플랫폼으로는 <code>spring-cloud-starter-bus-amqp</code>, <code>spring-cloud-starter-bus-kafka</code>을 선택할 수 있습니다. <code>bus-amqp</code>는 Rabbit MQ를 사용하고, <code>kafka</code>는 Kafka를 사용합니다. 본 예제는 Kafka를 기준으로 설명드리겠습니다.</p>
<h3><span id="kafka-docker">Kafka Docker</span><a href="#kafka-docker" class="header-anchor">#</a></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yaml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">confluentinc/cp-zookeeper:latest</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOOKEEPER_CLIENT_PORT:</span> <span class="number">2181</span></span><br><span class="line">      <span class="attr">ZOOKEEPER_TICK_TIME:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">22181</span><span class="string">:2181</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">confluentinc/cp-kafka:latest</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">29092</span><span class="string">:29092</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_BROKER_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092</span></span><br><span class="line">      <span class="attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="string">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span><br><span class="line">      <span class="attr">KAFKA_INTER_BROKER_LISTENER_NAME:</span> <span class="string">PLAINTEXT</span></span><br><span class="line">      <span class="attr">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>위 처럼 카프카 도커를 구성해서 도커를 구동시킵니다.</p>
<h3><span id="kapeuka-ibenteuro-byeongyeongsahang-jeonpa">카프카 이벤트로 변경사항 전파</span><a href="#kapeuka-ibenteuro-byeongyeongsahang-jeonpa" class="header-anchor">#</a></h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">application:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">        <span class="attr">bootstrap-servers:</span> <span class="string">localhost:29092</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">    <span class="attr">endpoints:</span></span><br><span class="line">        <span class="attr">web:</span></span><br><span class="line">            <span class="attr">exposure:</span></span><br><span class="line">                <span class="attr">include:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">&quot;refresh&quot;</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">&quot;bus-refresh&quot;</span></span><br></pre></td></tr></table></figure>
<p>위에서 구성한 카프카 설정, actuator으로 <code>bus-refresh</code>을 노출시키는 설정을 완료합니다. 해당 설정을 완료했다면 인스턴스를 2대를 각각 다른 포트로 애플리케이션을 구동시킵니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/eureka.png"></p>
<p>포스팅에서는 Eureka를 통해서 <code>order-service</code>를 랜덤 포트를 이용해서 2대를 구성했습니다. 포트가 각기 다르게 profile local으로 띄우기만 하면 되니 굳이 유레카에 해당 서버를 등록시킬 필요는 없습니다. 인스턴스가 2개를 띄웠다는 부분을 표시하기 위해서 이미지를 첨부했습니다.</p>
<p>각각 서버에서 <code>/orders/profile</code>을 호출해서 <code>message.profile</code>를 확인해보겠습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.0.5:58704/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 10</span><br><span class="line">Date: Sat, 07 Aug 2021 04:36:43 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">new local2</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 59ms; Content length: 10 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET http://192.168.0.5:59013/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 10</span><br><span class="line">Date: Sat, 07 Aug 2021 04:36:30 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">new local2</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 56ms; Content length: 10 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>로컬 프로퍼티를 정상적으로 인식하는 것을 확인할 수 있습니다. 그렇다면 Config Server의 프로퍼티를 <code>message.profile=&quot;local&quot;</code>으로 Push 한 이후 포트 59013 서버 1대에 <code>/actuator/busrefresh</code>를 호출하겠습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.0.5:59013/actuator/busrefresh</span><br><span class="line"></span><br><span class="line">HTTP/1.1 204 </span><br><span class="line">Date: Sat, 07 Aug 2021 04:42:33 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&lt;Response body is empty&gt;</span><br><span class="line"></span><br><span class="line">Response code: 204; Time: 6842ms; Content length: 0 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>정상적으로 호출이 완료되었으면 59013, 58704 서버를 모두 확인해보겠습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.0.5:58704/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 5</span><br><span class="line">Date: Sat, 07 Aug 2021 04:42:47 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">local</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 47ms; Content length: 5 bytes</span><br><span class="line"></span><br><span class="line">GET http://192.168.0.5:59013/orders/profile</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 5</span><br><span class="line">Date: Sat, 07 Aug 2021 04:43:05 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">local</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 151ms; Content length: 5 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>59013 서버에 이벤트를 반영했지만 58704 서버에도 해당 내용이 전파된 것을 확인할 수 있습니다.</strong></p>
<h3><span id="ibenteu-hwagin">이벤트 확인</span><a href="#ibenteu-hwagin" class="header-anchor">#</a></h3><p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/kafka-log.png"></p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/kafka-matric.png"></p>
<p>카프카 로그를 보면 정상적으로 이벤트가 발행된 부분을 확인할 수 있으며, 위에서 지정한 토픽 이름인 <code>$&#123;spring.application.name&#125;config-bus-refesh-event</code>을 확인할 수 있습니다. 만약 코드 레벨에서 Config 변경 이벤트 구독 받아 후속 작업을 하고 싶은 경우에는 <code>@EventListener</code>으로 <code>RefreshRemoteApplicationEvent</code> 이벤트를 구독 받아 처리할 수 있습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onRefreshRemoteEvent</span><span class="params">(event: <span class="type">RefreshRemoteApplicationEvent</span>)</span></span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;Event....&quot;</span>)</span><br><span class="line">    log.info(event.id)</span><br><span class="line">    log.info(event.source.toString())</span><br><span class="line">    log.info(event.originService)</span><br><span class="line">    log.info(event.destinationService)</span><br><span class="line">    log.info(<span class="string">&quot;Event....&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-msa/docs/images/bus-event.png"></p>
<p>디버깅 모드로 실제 값들을 확인할 수 있습니다.</p>

            


        </div>
    </div>
    <!-- Table of Contents -->
    <div id="toc-container">
        <div class="toc-title">목차</div>
        <ul id="toc-list"></ul>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Event/" rel="tag">Event</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/MSA/" rel="tag">MSA</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Spring/" rel="tag">Spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/sql-test/"
                    data-tooltip="Sql을 통해서 테스트 코드를 쉽게 작성하자"
                    aria-label="이전: Sql을 통해서 테스트 코드를 쉽게 작성하자"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-config-server/"
                    data-tooltip="Spring Cloud Config Server 정리"
                    aria-label="다음: Spring Cloud Config Server 정리"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-config-client/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-config-client/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        

                
                    <!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                

            
        
    </div>
</article>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2026 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/sql-test/"
                    data-tooltip="Sql을 통해서 테스트 코드를 쉽게 작성하자"
                    aria-label="이전: Sql을 통해서 테스트 코드를 쉽게 작성하자"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/spring-config-server/"
                    data-tooltip="Spring Cloud Config Server 정리"
                    aria-label="다음: Spring Cloud Config Server 정리"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-config-client/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-config-client/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-config-client/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-config-client/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>



<script src="/assets/js/toc.js"></script>


<!--SCRIPTS END-->


    




    </body>
</html>


<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="sBAfGubPxv1ol5QEVGgOJ4ggp5spK-zFFXpK-Pd2xZM" />
    <meta name="naver-site-verification" content="a37ea649edf26e70c3de94f9cb034f9d6e11de3f" />
    <meta name="generator" content="Yun Blog">
    <title>외부 인프라스트럭처 테스트 - Yun Blog</title>
    <meta name="author" content="Yun">
    
        <meta name="keywords" content="Node,Spring,Spring Boot,Spring Batch,Kotlin,기술 블로그,JPA,Mongo,MySQL,OOP,">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg"},"articleBody":"\n해당 코드는 Github에서 확인할 수 있습니다.\n\n대부분의 애플리케이션은 외부 인프라스트럭처와 통신하면서 진행됩니다. 대표적인 외부 스트럭처는 외부 API들이 있습니다. 이런 외부 인프라스트럭처는 Mocking 해서 원하는 응답 값을 지정하고 검증하고 싶은 부분을 검증을 진행하는 것이 흔한 패턴입니다.\n대표적으로 Mockito 프레임워크가 있으며 Mock 테스트는  Spring Guide - 테스트 전략 : Service 테스트, RestTemplate Mock 기반 테스트 하기에서 포스팅한 적 있습니다. 그런데 이런 식의 Mock 테스트 코드는 문제없지만, 실제 구동 환경(Local, Sandbox, Beta)에서는 문제가 있을 수 있습니다.\n요구사항#\n파트너 등록을 진행한다.\n파트너 등록 시 계좌 주명, 계좌번호 일치 여부를 검증한다.\n계좌 주명 검증은 신한 API를 사용한다.\nAPI는 허가된 서버만 호출할 수 있다.\nAPI Call 1건당 비용이 발생한다.\n\n\n계좌 주명, 계좌번호 일치하는 경우 저장한다.\n계좌 주명, 계좌번호 일치하지 않은 경우 예외를 발생시킨다.\n\n\n\nCode#코드는 자세히 보실 필요 없습니다. 아래의 흐름만 읽어 보시면 됩니다.\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970@RestController@RequestMapping(&quot;/partners&quot;)class PartnerApi(    private val partnerRegistrationService: PartnerRegistrationService) &#123;    @PostMapping    fun register(@RequestBody @Valid dto: PartnerRegistrationRequest) &#123;        partnerRegistrationService.register(dto)    &#125;&#125;data class PartnerRegistrationRequest(    @field:NotEmpty    val name: String,    @field:NotEmpty    val accountHolder: String,    @field:NotEmpty    val accountNumber: String)@Serviceclass PartnerRegistrationService(    private val partnerRepository: PartnerRepository,    private val bankClient: ShinhanBankClient) &#123;    fun register(dto: PartnerRegistrationRequest): Partner &#123;        // 은행 코드 검증일 진행한다        bankClient.verifyAccountHolder(            accountHolder = dto.accountHolder,            accountNumber = dto.accountHolder        )        return partnerRepository.save(Partner(            accountNumber = dto.accountNumber,            accountHolder = dto.accountHolder,            name = dto.name        ))    &#125;&#125;@Serviceclass ShinhanBankClient(    private val shinChanBankApi: ShinChanBankApi) &#123;    // 계좌주명, 계좝번호가 일치하지 않으면 예외 발생    fun verifyAccountHolder(accountNumber: String, accountHolder: String) &#123;        val response = shinChanBankApi.checkAccountHolder(accountHolder, accountNumber)        require(!response.matched.not()) &#123; &quot;계좌주명이 일치하지 않습니다.&quot; &#125;    &#125;&#125;@Serviceclass ShinChanBankApi &#123;    // 계좌주명, 계좌번호가 하드 코딩된 값과 일치여불르 확인한다.    fun checkAccountHolder(accountHolder: String, accountNumber: String): AccountHolderVerificationResponse &#123;        return when &#123;            accountHolder == &quot;yun&quot; &amp;&amp; accountNumber == &quot;110-2222-2222&quot; -&gt; AccountHolderVerificationResponse(true)            else -&gt; AccountHolderVerificationResponse(false)        &#125;    &#125;&#125;data class AccountHolderVerificationResponse(    val matched: Boolean)\n\n예제 코드가 길지만 흐름은 간단합니다. 파트너 등록을 진행할 때 ShinhanBankClient를 통해서 계좌 주명 일치 여부를 검증하고, 일치하지 않은 경우 예외가 발생시켜 파트너 등록을 진행하지 않습니다.\n본 포스팅과는 관련 없는 내용이지만 실제 API Call은 ShinChanBankApi 클래스에서 진행하고, 일치하지 않은 경우 예외가 발생하는 비즈니스 코드는 ShinhanBankClient 클래스에서 진행합니다.\n단순하게 API 통신만 담당하는 객체, API 통신을 담당하는 객체를 이용해서 비즈니스 코드를 만드는 객체 이렇게 객체의 책임과 역할을 명확하게 나누고 그 크기를 작게 유지하는 것이 좋은 설계 좋은 코드라고 생각합니다.\nTest Code#12345678910111213141516171819202122232425internal class PartnerApiTest : SpringApiTestSupport() &#123;    @MockBean    private lateinit var shinChanBankApi: ShinChanBankApi    @Test    internal fun `파트너 등록`() &#123;        given(shinChanBankApi.checkAccountHolder(anyString(), anyString()))            .willReturn(AccountHolderVerificationResponse(true))        mockMvc.post(&quot;/partners&quot;) &#123;            contentType = MediaType.APPLICATION_JSON            content = &quot;&quot;&quot;                &#123;                  &quot;name&quot; : &quot;123&quot;,                  &quot;accountHolder&quot; : &quot;123&quot;,                  &quot;accountNumber&quot; :  &quot;123&quot;                &#125;            &quot;&quot;&quot;.trimIndent()        &#125;.andExpect &#123;            status &#123; isOk &#125;        &#125;    &#125;&#125;\nMockBean을 통해서 가짜 객체를 주입받고 given() 메서드를 통해서 일치한다는 가정을 하고 테스트를 진행하게 됩니다.\n\n해당 테스트는 잘 진행되는 것을 볼 수 있습니다.\n하지만 문제는 ?#\n하지만 문제가 있습니다. 실제 구동 환경(Local, Sandbox, Beta…)에서는 해당 API Call을 진행하면 예외가 발생합니다.\n허가된 Production 서버 이외의 조건들은 호출은 가능하지만 API 비용 발생 문제 등이 있어 Production 이외의 환경에서는 막는 것이 적절할 수 있습니다. 그 밖에 다양한 이유들이 있습니다.\n\n실제 Email을 호출하는 경우\n실제 SMS으로 문자가 나가는 경우\n실제 송금을 진행하는 경우\n상대 서버에 sandbox, beta 등 production 환경 이외의 테스트 서버가 없는 경우\n\n해당 이유들은 비용상의 문제, 서버 권한 문제 외 적으로 막아야 합니다. 그리고 무엇보다 Production 환경 외에서 해당 API를 사용(테스트) 할 수 없게 되는 것이 가장 큰 문제입니다.\n해결 방법#\n해결 방법은 간단합니다. ShinhanBankClient가 ShinhanBankApi 인터페이스를 의존하게 함으로써 의존관계를 인터페이스를 통해서 역전시키는 것입니다. 이것도 개방 폐쇄의 원칙: Open Close Principle에서 포스팅한 적 이 있습니다.\nCode#123456789101112131415161718192021222324252627282930313233343536373839404142434445interface ShinChanBankApi &#123;    fun checkAccountHolder(accountHolder: String, accountNumber: String): AccountHolderVerificationResponse&#125;@Service(&quot;shinChanBankApi&quot;)@Profile(&quot;production&quot;)class ShinChanBankApiImpl : ShinChanBankApi &#123;    // 계좌주명, 계좌번호가 하드 코딩된 값과 일치여불르 확인한다.    override fun checkAccountHolder(accountHolder: String, accountNumber: String): AccountHolderVerificationResponse &#123;        return when &#123;            accountHolder == &quot;yun&quot; &amp;&amp; accountNumber == &quot;110-2222-2222&quot; -&gt; AccountHolderVerificationResponse(true)            else -&gt; AccountHolderVerificationResponse(false)        &#125;    &#125;&#125;@Service(&quot;shinChanBankApi&quot;)@Profile(&quot;sandbox&quot;, &quot;beta&quot;, &quot;local&quot;, &quot;test&quot;)private class ShinChanBankApMock : ShinChanBankApi &#123;    // 어떤 값이 들어 와도 일치 한다고 가정한다    override fun checkAccountHolder(accountHolder: String, accountNumber: String): AccountHolderVerificationResponse &#123;        return AccountHolderVerificationResponse(true)    &#125;&#125;@Serviceclass PartnerRegistrationService(    private val partnerRepository: PartnerRepository,    private val bankClient: ShinhanBankClient) &#123;    fun register(dto: PartnerRegistrationRequest): Partner &#123;        // 은행 코드 검증일 진행한다        bankClient.verifyAccountHolder(            accountHolder = dto.accountHolder,            accountNumber = dto.accountHolder        )        return partnerRepository.save(Partner(            accountNumber = dto.accountNumber,            accountHolder = dto.accountHolder,            name = dto.name        ))    &#125;&#125;\n\n@Service(&quot;beanName&quot;) beanName을 지정합니다.\n@Profile 어노테이션을 통해서 각 환경에 맞는 bean이 등록되게 진행합니다.\nPartnerRegistrationService에서 ShinChanBankApi 인터페이스를 의존하게 합니다.\n\n@Profile 잘못 설정해서 Bean이 2개 등록되는 경우 스프링에서 예외를 발생시키며 Bean 하나도 등록 못하는 경우에도 마찬가지로 예외가 발생합니다.\n스프링에서 Bean 관련 예외를 명확하게 표시해 주고 있지만 그래도 불안하다고 판단되면 Bean 등록하는 코드를 따로 작성해도 좋습니다.\nTest#\nspring.profiles.active=local 으로 지정하고 해당 API를 호출하면 Status 200을 응답받은 것을 확인할 수 있습니다.\n\nspring.profiles.active=local환경에서는 shinhanBankApi객체에 ShinhanBankApiMock이 등록된것을 확인할 수 있습니다.\n","dateCreated":"2020-03-29T00:00:00+09:00","dateModified":"2025-01-31T22:31:40+09:00","datePublished":"2020-03-29T00:00:00+09:00","description":"대부분의 애플리케이션은 외부 인프라스트럭처와 통신하면서 진행됩니다. 대표적인 외부 스트럭처는 외부 API들이 있습니다.","headline":"외부 인프라스트럭처 테스트","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://cheese10yun.github.io/spring-mock-test/"},"publisher":{"@type":"Organization","name":"Yun","sameAs":["https://github.com/cheese10yun"],"image":"yun-icon.jpg","logo":{"@type":"ImageObject","url":"yun-icon.jpg"}},"url":"https://cheese10yun.github.io/spring-mock-test/","keywords":"Test"}</script>
    <meta name="description" content="대부분의 애플리케이션은 외부 인프라스트럭처와 통신하면서 진행됩니다. 대표적인 외부 스트럭처는 외부 API들이 있습니다.">
<meta property="og:type" content="blog">
<meta property="og:title" content="외부 인프라스트럭처 테스트">
<meta property="og:url" content="https://cheese10yun.github.io/spring-mock-test/index.html">
<meta property="og:site_name" content="Yun Blog">
<meta property="og:description" content="대부분의 애플리케이션은 외부 인프라스트럭처와 통신하면서 진행됩니다. 대표적인 외부 스트럭처는 외부 API들이 있습니다.">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/partenr-test-code.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/api-result.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/TIL/bc6ee987d4073d59ec884210215ba1fc9307c0de/assets/partner-ocp.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/bean-error.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/result.png">
<meta property="og:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/bean-.png">
<meta property="article:published_time" content="2020-03-28T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-31T13:31:40.668Z">
<meta property="article:author" content="Yun">
<meta property="article:tag" content="Test">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/partenr-test-code.png">
    
    
        
    
    
        <meta property="og:image" content="https://cheese10yun.github.io/assets/images/yun-icon.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    
    
<link rel="stylesheet" href="/assets/css/toc.css">

    
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-90907312-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-90907312-1');
    </script>


    

    
        
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5813739623204880" crossorigin="anonymous"></script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Yun Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="링크 열기: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="저자에 대해 더 알아보기"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
                </a>
                <h4 class="sidebar-profile-name">Yun</h4>
                
                    <h5 class="sidebar-profile-bio"><p>기술 블로그</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="태그"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">태그</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="아카이브"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">아카이브</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/cheese10yun"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            외부 인프라스트럭처 테스트
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-03-29T00:00:00+09:00">
	
		    2020/03/29
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <blockquote>
<p>해당 코드는 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/blog-sample/tree/master/spring-mock-test">Github</a>에서 확인할 수 있습니다.</p>
</blockquote>
<p>대부분의 애플리케이션은 외부 인프라스트럭처와 통신하면서 진행됩니다. 대표적인 외부 스트럭처는 외부 API들이 있습니다. 이런 외부 인프라스트럭처는 Mocking 해서 원하는 응답 값을 지정하고 검증하고 싶은 부분을 검증을 진행하는 것이 흔한 패턴입니다.</p>
<p>대표적으로 Mockito 프레임워크가 있으며 Mock 테스트는  <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/spring-guide/blob/master/docs/test-guide.md#mocktest">Spring Guide - 테스트 전략 : Service 테스트</a>, <a href="https://cheese10yun.github.io/rest-template-mock-test/">RestTemplate Mock 기반 테스트 하기</a>에서 포스팅한 적 있습니다. 그런데 이런 식의 Mock 테스트 코드는 문제없지만, 실제 구동 환경(Local, Sandbox, Beta)에서는 문제가 있을 수 있습니다.</p>
<h2><span id="yogusahang">요구사항</span><a href="#yogusahang" class="header-anchor">#</a></h2><ul>
<li>파트너 등록을 진행한다.</li>
<li>파트너 등록 시 계좌 주명, 계좌번호 일치 여부를 검증한다.<ul>
<li>계좌 주명 검증은 신한 API를 사용한다.<ul>
<li>API는 허가된 서버만 호출할 수 있다.</li>
<li>API Call 1건당 비용이 발생한다.</li>
</ul>
</li>
<li>계좌 주명, 계좌번호 일치하는 경우 저장한다.</li>
<li>계좌 주명, 계좌번호 일치하지 않은 경우 예외를 발생시킨다.</li>
</ul>
</li>
</ul>
<h2><span id="code">Code</span><a href="#code" class="header-anchor">#</a></h2><p>코드는 자세히 보실 필요 없습니다. 아래의 흐름만 읽어 보시면 됩니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/partners&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PartnerApi</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> partnerRegistrationService: PartnerRegistrationService</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> dto: <span class="type">PartnerRegistrationRequest</span>)</span></span> &#123;</span><br><span class="line">        partnerRegistrationService.register(dto)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">PartnerRegistrationRequest</span>(</span><br><span class="line">    <span class="meta">@field:NotEmpty</span></span><br><span class="line">    <span class="keyword">val</span> name: String,</span><br><span class="line">    <span class="meta">@field:NotEmpty</span></span><br><span class="line">    <span class="keyword">val</span> accountHolder: String,</span><br><span class="line">    <span class="meta">@field:NotEmpty</span></span><br><span class="line">    <span class="keyword">val</span> accountNumber: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PartnerRegistrationService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> partnerRepository: PartnerRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bankClient: ShinhanBankClient</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(dto: <span class="type">PartnerRegistrationRequest</span>)</span></span>: Partner &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 은행 코드 검증일 진행한다</span></span><br><span class="line">        bankClient.verifyAccountHolder(</span><br><span class="line">            accountHolder = dto.accountHolder,</span><br><span class="line">            accountNumber = dto.accountHolder</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> partnerRepository.save(Partner(</span><br><span class="line">            accountNumber = dto.accountNumber,</span><br><span class="line">            accountHolder = dto.accountHolder,</span><br><span class="line">            name = dto.name</span><br><span class="line">        ))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShinhanBankClient</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> shinChanBankApi: ShinChanBankApi</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 계좌주명, 계좝번호가 일치하지 않으면 예외 발생</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">verifyAccountHolder</span><span class="params">(accountNumber: <span class="type">String</span>, accountHolder: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> response = shinChanBankApi.checkAccountHolder(accountHolder, accountNumber)</span><br><span class="line">        require(!response.matched.not()) &#123; <span class="string">&quot;계좌주명이 일치하지 않습니다.&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShinChanBankApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 계좌주명, 계좌번호가 하드 코딩된 값과 일치여불르 확인한다.</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkAccountHolder</span><span class="params">(accountHolder: <span class="type">String</span>, accountNumber: <span class="type">String</span>)</span></span>: AccountHolderVerificationResponse &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">            accountHolder == <span class="string">&quot;yun&quot;</span> &amp;&amp; accountNumber == <span class="string">&quot;110-2222-2222&quot;</span> -&gt; AccountHolderVerificationResponse(<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">else</span> -&gt; AccountHolderVerificationResponse(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">AccountHolderVerificationResponse</span>(</span><br><span class="line">    <span class="keyword">val</span> matched: <span class="built_in">Boolean</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>예제 코드가 길지만 흐름은 간단합니다. 파트너 등록을 진행할 때 ShinhanBankClient를 통해서 계좌 주명 일치 여부를 검증하고, 일치하지 않은 경우 예외가 발생시켜 파트너 등록을 진행하지 않습니다.</p>
<p>본 포스팅과는 관련 없는 내용이지만 실제 API Call은 <code>ShinChanBankApi</code> 클래스에서 진행하고, 일치하지 않은 경우 예외가 발생하는 비즈니스 코드는 <code>ShinhanBankClient</code> 클래스에서 진행합니다.</p>
<p><strong>단순하게 API 통신만 담당하는 객체, API 통신을 담당하는 객체를 이용해서 비즈니스 코드를 만드는 객체</strong> 이렇게 객체의 책임과 역할을 명확하게 나누고 그 크기를 작게 유지하는 것이 좋은 설계 좋은 코드라고 생각합니다.</p>
<h3><span id="test-code">Test Code</span><a href="#test-code" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">PartnerApiTest</span> : <span class="type">SpringApiTestSupport</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> shinChanBankApi: ShinChanBankApi</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> `파트너 등록`<span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        given(shinChanBankApi.checkAccountHolder(anyString(), anyString()))</span><br><span class="line">            .willReturn(AccountHolderVerificationResponse(<span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line">        mockMvc.post(<span class="string">&quot;/partners&quot;</span>) &#123;</span><br><span class="line">            contentType = MediaType.APPLICATION_JSON</span><br><span class="line">            content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;name&quot; : &quot;123&quot;,</span></span><br><span class="line"><span class="string">                  &quot;accountHolder&quot; : &quot;123&quot;,</span></span><br><span class="line"><span class="string">                  &quot;accountNumber&quot; :  &quot;123&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">        &#125;.andExpect &#123;</span><br><span class="line">            status &#123; isOk &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MockBean을 통해서 가짜 객체를 주입받고 <code>given()</code> 메서드를 통해서 일치한다는 가정을 하고 테스트를 진행하게 됩니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/partenr-test-code.png"></p>
<p>해당 테스트는 잘 진행되는 것을 볼 수 있습니다.</p>
<h2><span id="hajiman-munjeneun">하지만 문제는 ?</span><a href="#hajiman-munjeneun" class="header-anchor">#</a></h2><p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/api-result.png"></p>
<p><strong>하지만 문제가 있습니다. 실제 구동 환경(Local, Sandbox, Beta…)에서는 해당 API Call을 진행하면 예외가 발생합니다.</strong></p>
<p>허가된 Production 서버 이외의 조건들은 호출은 가능하지만 API 비용 발생 문제 등이 있어 Production 이외의 환경에서는 막는 것이 적절할 수 있습니다. 그 밖에 다양한 이유들이 있습니다.</p>
<ul>
<li>실제 Email을 호출하는 경우</li>
<li>실제 SMS으로 문자가 나가는 경우</li>
<li>실제 송금을 진행하는 경우</li>
<li>상대 서버에 sandbox, beta 등 production 환경 이외의 테스트 서버가 없는 경우</li>
</ul>
<p>해당 이유들은 비용상의 문제, 서버 권한 문제 외 적으로 막아야 합니다. <strong>그리고 무엇보다 Production 환경 외에서 해당 API를 사용(테스트) 할 수 없게 되는 것이 가장 큰 문제입니다.</strong></p>
<h2><span id="haegyeol-bangbeob">해결 방법</span><a href="#haegyeol-bangbeob" class="header-anchor">#</a></h2><p><img src="https://raw.githubusercontent.com/cheese10yun/TIL/bc6ee987d4073d59ec884210215ba1fc9307c0de/assets/partner-ocp.png"></p>
<p>해결 방법은 간단합니다. ShinhanBankClient가 ShinhanBankApi 인터페이스를 의존하게 함으로써 <strong>의존관계를 인터페이스를 통해서 역전시키는 것입니다.</strong> 이것도 <a target="_blank" rel="noopener" href="https://github.com/cheese10yun/spring-SOLID/blob/master/docs/OCP.md">개방 폐쇄의 원칙: Open Close Principle</a>에서 포스팅한 적 이 있습니다.</p>
<h3><span id="code">Code</span><a href="#code" class="header-anchor">#</a></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ShinChanBankApi</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">checkAccountHolder</span><span class="params">(accountHolder: <span class="type">String</span>, accountNumber: <span class="type">String</span>)</span></span>: AccountHolderVerificationResponse</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service(<span class="string">&quot;shinChanBankApi&quot;</span>)</span></span><br><span class="line"><span class="meta">@Profile(<span class="string">&quot;production&quot;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShinChanBankApiImpl</span> : <span class="type">ShinChanBankApi</span> &#123;</span><br><span class="line">    <span class="comment">// 계좌주명, 계좌번호가 하드 코딩된 값과 일치여불르 확인한다.</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkAccountHolder</span><span class="params">(accountHolder: <span class="type">String</span>, accountNumber: <span class="type">String</span>)</span></span>: AccountHolderVerificationResponse &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">            accountHolder == <span class="string">&quot;yun&quot;</span> &amp;&amp; accountNumber == <span class="string">&quot;110-2222-2222&quot;</span> -&gt; AccountHolderVerificationResponse(<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">else</span> -&gt; AccountHolderVerificationResponse(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service(<span class="string">&quot;shinChanBankApi&quot;</span>)</span></span><br><span class="line"><span class="meta">@Profile(<span class="string">&quot;sandbox&quot;</span>, <span class="string">&quot;beta&quot;</span>, <span class="string">&quot;local&quot;</span>, <span class="string">&quot;test&quot;</span>)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ShinChanBankApMock</span> : <span class="type">ShinChanBankApi</span> &#123;</span><br><span class="line">    <span class="comment">// 어떤 값이 들어 와도 일치 한다고 가정한다</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkAccountHolder</span><span class="params">(accountHolder: <span class="type">String</span>, accountNumber: <span class="type">String</span>)</span></span>: AccountHolderVerificationResponse &#123;</span><br><span class="line">        <span class="keyword">return</span> AccountHolderVerificationResponse(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PartnerRegistrationService</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> partnerRepository: PartnerRepository,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bankClient: ShinhanBankClient</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(dto: <span class="type">PartnerRegistrationRequest</span>)</span></span>: Partner &#123;</span><br><span class="line">        <span class="comment">// 은행 코드 검증일 진행한다</span></span><br><span class="line">        bankClient.verifyAccountHolder(</span><br><span class="line">            accountHolder = dto.accountHolder,</span><br><span class="line">            accountNumber = dto.accountHolder</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> partnerRepository.save(Partner(</span><br><span class="line">            accountNumber = dto.accountNumber,</span><br><span class="line">            accountHolder = dto.accountHolder,</span><br><span class="line">            name = dto.name</span><br><span class="line">        ))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>@Service(&quot;beanName&quot;)</code> beanName을 지정합니다.</li>
<li><code>@Profile</code> 어노테이션을 통해서 각 환경에 맞는 bean이 등록되게 진행합니다.</li>
<li><strong><code>PartnerRegistrationService</code>에서 <code>ShinChanBankApi</code> 인터페이스를 의존하게 합니다.</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/bean-error.png"><br><code>@Profile</code> 잘못 설정해서 Bean이 2개 등록되는 경우 스프링에서 예외를 발생시키며 Bean 하나도 등록 못하는 경우에도 마찬가지로 예외가 발생합니다.</p>
<p>스프링에서 Bean 관련 예외를 명확하게 표시해 주고 있지만 그래도 불안하다고 판단되면 Bean 등록하는 코드를 따로 작성해도 좋습니다.</p>
<h3><span id="test">Test</span><a href="#test" class="header-anchor">#</a></h3><p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/result.png"></p>
<p><code>spring.profiles.active=local</code> 으로 지정하고 해당 API를 호출하면 <code>Status 200</code>을 응답받은 것을 확인할 수 있습니다.</p>
<p><img src="https://raw.githubusercontent.com/cheese10yun/blog-sample/master/spring-mock-test/image/bean-.png"></p>
<p><code>spring.profiles.active=local</code>환경에서는 <code>shinhanBankApi</code>객체에 <code>ShinhanBankApiMock</code>이 등록된것을 확인할 수 있습니다.</p>

            


        </div>
    </div>
    <!-- Table of Contents -->
    <div id="toc-container">
        <div class="toc-title">목차</div>
        <ul id="toc-list"></ul>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">태그</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Test/" rel="tag">Test</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/github-action-1/"
                    data-tooltip="Github Action With Gradle"
                    aria-label="이전: Github Action With Gradle"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-test-support/"
                    data-tooltip="JPA 기반 테스트 코드 작성 팁"
                    aria-label="다음: JPA 기반 테스트 코드 작성 팁"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-mock-test/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-mock-test/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        

                
                    <!--  utteranc comment -->

<script src="https://utteranc.es/client.js"
        repo="cheese10yun/blog-comment"
        issue-term="title"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                

            
        
    </div>
</article>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2026 Yun. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/github-action-1/"
                    data-tooltip="Github Action With Gradle"
                    aria-label="이전: Github Action With Gradle"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">이전</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/jpa-test-support/"
                    data-tooltip="JPA 기반 테스트 코드 작성 팁"
                    aria-label="다음: JPA 기반 테스트 코드 작성 팁"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">다음</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="이 포스트 공유하기"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-mock-test/"
                    title="Facebook에 공유하기"
                    aria-label="Facebook에 공유하기"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-mock-test/"
                    title="Twitter에 공유하기"
                    aria-label="Twitter에 공유하기"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="맨 위로">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://cheese10yun.github.io/spring-mock-test/"
                        aria-label="Facebook에 공유하기"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Facebook에 공유하기</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://cheese10yun.github.io/spring-mock-test/"
                        aria-label="Twitter에 공유하기"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Twitter에 공유하기</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/yun-icon.jpg" alt="저자 이미지"/>
        
            <h4 id="about-card-name">Yun</h4>
        
            <div id="about-card-bio"><p>기술 블로그</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>



<script src="/assets/js/toc.js"></script>


<!--SCRIPTS END-->


    




    </body>
</html>
